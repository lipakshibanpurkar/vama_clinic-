<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAMA Clinic - Patient Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --light: #f8fafc;
            --dark: #1e293b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --sidebar-width: 250px;
        }
        body {
            display: flex;
            min-height: 100vh;
            background-color: #f1f5f9;
            color: var(--dark);
        }
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark);
            color: white;
            height: 100vh;
            position: fixed;
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        .sidebar-menu {
            padding: 15px 0;
        }
        .sidebar-menu ul {
            list-style: none;
        }
        .sidebar-menu li {
            margin-bottom: 5px;
        }
        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #cbd5e1;
            text-decoration: none;
            transition: all 0.3s;
            min-height: 44px;
        }
        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: #334155;
            color: white;
            border-left: 4px solid var(--primary);
        }
        .sidebar-menu i {
            width: 20px;
            text-align: center;
        }
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            width: 44px;
            height: 44px;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            cursor: pointer;
        }
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .sidebar-overlay.active {
            display: block;
        }
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: all 0.3s ease;
            width: calc(100% - var(--sidebar-width));
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 5px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .vama-striped {
            font-family: "Arial Black", "Arial", sans-serif;
            font-size: 28px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            line-height: 1;
        }
        .v {
            background-image: repeating-linear-gradient(
                90deg,
                #448fdf 0px 1px,
                transparent 3px 5px
            );
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            display: inline-block;
        }
        .ama {
            background-image: repeating-linear-gradient(
                90deg,
                #c43753 0px 1px,
                transparent 3px 5px
            );
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            display: inline-block;
        }
        .clinic-name {
            font-size: 14px;
            font-weight: bold;
            color: #75b0eb;
            letter-spacing: 1px;
            margin-top: 5px;
        }
        .header-title h1 {
            font-size: 1.8rem;
            color: var(--dark);
            font-weight: 600;
        }
        .header-title p {
            color: var(--secondary);
            font-size: 0.9rem;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--light);
            padding: 8px 15px;
            border-radius: 30px;
            cursor: pointer;
            position: relative;
            min-height: 44px;
        }
        .user-profile img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 180px;
            padding: 10px 0;
            margin-top: 5px;
            display: none;
            z-index: 100;
        }
        .user-dropdown.active {
            display: block;
        }
        .user-dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 44px;
        }
        .user-dropdown-item:hover {
            background: var(--light);
        }
        .user-dropdown-item.active {
            background: #e0f2fe;
            color: var(--primary);
            font-weight: 500;
        }
        .notification-icon {
            position: relative;
            font-size: 1.3rem;
            color: var(--secondary);
            cursor: pointer;
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .page-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .page {
            display: none;
            background: white;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        .page.active {
            display: block;
        }
        .page-title {
            font-size: 14px;
            color: #2c3e50;
            padding: 4px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }
        .registration-form {
            padding: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        .form-column {
            flex: 1;
            padding: 0 10px;
            min-width: 250px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        input,
        select,
        textarea {
            width: 100%;
            padding: 4px 7px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s;
        }
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .form-note {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }
        .vital-signs {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 25px 0;
        }
        .section-title {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        .form-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
        }
        .btn-submit {
            background: var(--primary);
            color: white;
        }
        .btn-submit:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }
        .btn-clear {
            background: var(--danger);
            color: white;
        }
        .btn-clear:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }
        .appointments-container,
        .database-container {
            padding: 20px;
        }
        .search-container {
            background: var(--light);
            padding: 5px;
            border-radius: 1px;
            margin-bottom: 5px;
        }
        .search-box {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .search-input {
            flex: 1;
            min-width: 250px;
            position: relative;
        }
        .search-input input {
            width: 100%;
            padding: 6px 5px 12px 40px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        .search-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .search-input i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary);
        }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        .appointments-table,
        .database-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .appointments-table th,
        .database-table th {
            background: var(--primary);
            color: white;
            padding: 5px;
            text-align: left;
            font-weight: 600;
        }
        .appointments-table td,
        .database-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        .appointments-table tr:nth-child(even),
        .database-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .appointments-table tr:hover,
        .database-table tr:hover {
            background: #e3f2fd;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-scheduled {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status-completed {
            background: #e3f2fd;
            color: #1565c0;
        }
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        .action-icons {
            display: flex;
            gap: 5px;
        }
        .action-icon {
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 32px;
            min-width: 32px;
            transition: all 0.3s;
        }
        .btn-echo {
            background: #3b82f6;
            color: white;
        }
        .btn-echo:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        .btn-consult {
            background: #10b981;
            color: white;
        }
        .btn-consult:hover {
            background: #059669;
            transform: scale(1.05);
        }
        .btn-edit {
            background: var(--warning);
            color: #212529;
        }
        .btn-delete {
            background: var(--danger);
            color: white;
        }
        .btn-delete:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 5px;
        }
        .role-admin {
            background: var(--primary);
            color: white;
        }
        .role-receptionist {
            background: var(--success);
            color: white;
        }
        .mobile-cards {
            display: none;
        }
        .mobile-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .mobile-card-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        .mobile-card-row:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        .mobile-card-label {
            font-weight: 600;
            color: var(--secondary);
        }
        .mobile-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .mobile-card-actions .action-icon {
            flex: 1;
            justify-content: center;
        }
        .echo-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 5px;
            margin-bottom: 30px;
        }
        .echo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e2e8f0;
        }
        .echo-header h2 {
            font-size: 1.5rem;
            color: var(--dark);
            font-weight: 600;
        }

        /* Report Controls */
        .report-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .report-controls button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
        }

        .edit-btn {
            background: var(--warning);
            color: white;
        }

        .edit-btn:hover {
            background: #e58e0c;
        }

        .print-btn {
            background: var(--primary);
            color: white;
        }

        .print-btn:hover {
            background: var(--primary-dark);
        }

        .pdf-btn {
            background: var(--danger);
            color: white;
        }

        .pdf-btn:hover {
            background: #dc2626;
        }

        .save-btn {
            background: var(--success);
            color: white;
        }

        .save-btn:hover {
            background: #0da271;
        }

        .report-page {
            width: 100%;
            max-width: 210mm;
            min-height: 297mm;
            padding: 15mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .report-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            border-bottom: 2px solid #000;
            padding-bottom: 8px;
        }
        .report-logo {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #0073e6, #c43753);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            text-align: center;
            padding: 4px;
        }
        .report-vama-center {
            flex: 1;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .report-vama-striped {
            font-family: "Arial Black", "Arial", sans-serif;
            font-size: 60px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
            line-height: 1;
            margin-bottom: 4px;
        }
        .report-v {
            background-image: repeating-linear-gradient(
                90deg,
                #448fdf 0px 1px,
                transparent 3px 5px
            );
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            display: inline-block;
        }
        .report-ama {
            background-image: repeating-linear-gradient(
                90deg,
                #c43753 0px 1px,
                transparent 3px 5px
            );
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            display: inline-block;
        }
        .report-clinic-name {
            font-size: 12px;
            font-weight: bold;
            color: #75b0eb;
            letter-spacing: 0.8px;
            margin: 0;
        }
        .report-header-right {
            text-align: right;
            font-size: 12px;
            color: #555;
        }
        .report-doctors {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            border-top: 2px solid #0073e6;
            border-bottom: 2px solid #0073e6;
            padding: 6px 0;
            position: relative;
        }
        .report-doctors::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 80%;
            background-color: #0073e6;
        }
        .report-doctor {
            width: 45%;
            font-size: 12px;
            line-height: 1.3;
            padding: 0 8px;
        }
        .report-doctor b {
            font-size: 13px;
            color: #2c3e50;
        }
        .report-patient-info {
            margin-top: 12px;
            padding: 10px;
            border-radius: 4px;
            flex-direction: row;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .report-patient-info table {
            width: 100%;
            border-collapse: collapse;
        }
        .report-patient-info td {
            padding: 4px 8px;
            vertical-align: top;
        }
        .report-patient-info b {
            color: #2c3e50;
        }
        .report-title {
            text-align: center;
            margin: 20px 0 12px;
            font-weight: bold;
            font-size: 16px;
            text-decoration: underline;
            color: #2c3e50;
        }
        .report-body {
            font-size: 11px;
            line-height: 1.3;
            padding: 0 8px;
        }
        .report-section {
            margin-bottom: 15px;
        }
        .section-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 4px;
        }
         b {
            color: #2c3e50;
        }
        .report-list {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        .report-list li {
            margin-bottom: 5px;
        }
        .report-signature {
            margin-top: 40px;
            font-size: 13px;
            text-align: right;
            padding-right: 15px;
        }
        .report-signature b {
            color: #2c3e50;
        }
        .report-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #0073e6;
            color: #fff;
            text-align: center;
            font-size: 12px;
            padding: 6px 0;
        }
      @media print {
   @page {
        margin: 15mm 15mm 4mm 15mm !important; /* Equal left and right margins */
        size: auto;
    }
    
    body {
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        line-height: 1 !important;
        font-size: 12pt !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    body * {
        visibility: hidden;
    }

    .report-page,
    .report-page * {
        visibility: visible !important;
        background: white !important;
        color: black !important;
        box-shadow: none !important;
        border: none !important;
        outline: none !important;
    }

    .report-page {
        position: absolute !important;
        left: 0 !important;
        top: 0 !important;
        width: 100% !important;
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        box-shadow: none !important;
        page-break-after: always;
        font-size: 12pt !important;
        line-height: 1.3 !important;
        border: none !important;
        outline: none !important;
    }

    /* Hide unnecessary elements */
    .sidebar, .header, .page-title, .search-container, .report-controls, 
    .echo-edit-controls, .echo-container, .bottom-nav, .footer, 
    .mobile-menu-toggle, .sidebar-overlay, .mobile-report-controls, 
    .mobile-report-expanded, .consult-edit-controls, .consult-controls, 
    .mobilereport-controls, #registration-page, #appointments-page, 
    #database-page, .report-header, .report-doctors, .report-footer, 
    .report-logo, .report-vama-center, .report-vama-striped, 
    .report-clinic-name, .report-header-right {
        display: none !important;
        visibility: hidden !important;
    }

    .main-content,
    .page-container {
        margin-left: 0 !important;
        width: 100% !important;
        padding: 0 !important;
        background: white !important;
        height: auto !important;
        overflow: visible !important;
        max-width: 100% !important;
        box-shadow: none !important;
        border: none !important;
    }

    /* Remove gray background from consult content */
    .consult-content {
        background: white !important;
        border: none !important;
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    /* Remove any editing styles */
    .editing, .editable-field, .editable-patient-details {
        background: white !important;
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
    }

    /* Top spacing - 15 lines from top */
    .report-page::before {
        content: "";
        display: block;
        height: 18em;
        width: 100%;
    }

    /* Report body with line gap */
    .report-body {
        visibility: visible !important;
        display: block !important;
        margin-top: 0.5em !important;
        padding-top: 0 !important;
        font-size: 9pt !important;
        line-height: 1.2 !important;
        color: black !important;
        background: white !important;
        page-break-inside: avoid !important;
        box-shadow: none !important;
        border: none !important;
    }

    /* Add gap after every text line */
    .report-body p,
    .report-section p,
    .gap-line,
    #echo-diagnosis p,
    #echo-impression p,
    .section-title + * {
        margin-bottom: 1em !important;
        line-height: 1.2 !important;
        font-size: 9pt !important;
        page-break-inside: avoid !important;
        background: white !important;
        color: black !important;
    }

    /* Patient details */
    .report-patient-info,
    .consult-patient-info {
        margin-top: 20px !important;
        margin-bottom: 30px !important;
        font-size: 11pt !important;
        line-height: 1.2 !important;
        width: 100% !important;
        padding-bottom: 15px !important;
        background: white !important;
        box-shadow: none !important;
        border: none !important;
    }

    .report-patient-info table,
    .consult-patient-info table {
        width: 100% !important;
        background: white !important;
    }

    .report-patient-info td,
    .consult-patient-info td {
        padding: 4px 8px !important;
        border: none !important;
        vertical-align: top !important;
        word-wrap: break-word !important;
        background: white !important;
    }

    /* Report title */
    .report-title {
        visibility: visible !important;
        display: block !important;
        text-align: center !important;
        margin: 3px 0 5px 0 !important;
        font-weight: bold !important;
        font-size: 12pt !important;
        text-decoration: underline !important;
        color: black !important;
        page-break-after: avoid !important;
        background: white !important;
    }

    /* Section styling */
    .report-section {
        margin-bottom: 20px !important;
        page-break-inside: avoid !important;
        background: white !important;
    }

    .section-title {
        font-weight: bold !important;
        color: black !important;
        margin-bottom: 1em !important;
        font-size: 11pt !important;
        padding-bottom: 3px !important;
        page-break-after: avoid !important;
        background: white !important;
        border-bottom: 1px solid black !important;
    }

    /* Doctor signature at bottom with spacing - 3 lines from bottom */
    .report-signature {
        position: fixed !important;
        bottom: 20mm !important;
        right: 15mm !important;
        text-align: right !important;
        font-size: 11pt !important;
        line-height: 1 !important;
        page-break-before: avoid !important;
        padding-top: 20px !important;
        padding-bottom: 25px !important;
        margin-top: 50px !important;
        background: white !important;
    }
    .consultation-report-page .report-signature {
        display: block !important;
        visibility: visible !important;
        position: fixed !important;
        bottom: 25mm !important;
        right: 15mm !important;
        text-align: right !important;
        font-size: 11pt !important;
        line-height: 1.2 !important;
        page-break-before: avoid !important;
        background: white !important;
    }

    /* Hide edit elements */
    .editable-field .edit-hint,
    .echo-edit-controls,
    .consult-edit-controls {
        display: none !important;
    }

    /* Ensure black text and white background */
    .report-page * {
        color: black !important;
        background: white !important;
        box-shadow: none !important;
        border-color: black !important;
    }

    /* Remove any gray backgrounds specifically */
    .consult-preset-controls,
    .custom-buttons-controls,
    .echo-preset-controls,
    .echo-custom-buttons-controls {
        display: none !important;
        background: white !important;
    }

    /* Prevent page breaks */
    .report-patient-info,
    .report-title,
    .report-signature {
        page-break-inside: avoid !important;
    }

    .report-page:last-child {
        page-break-after: auto !important;
    }

    /* Consultation specific */
    .consult-patient-info {
        font-size: 11pt !important;
        background: white !important;
    }
    
    #consult-anc,
    #consult-perinatal,
    #consult-device,
    #consult-suck-cycle,
    #consult-other-significant,
    #consult-echo,
    #consult-ecg,
    #consult-medication1,
    #consult-advice,
    #consult-followup {
        font-size: 11pt !important;
        line-height: 1.8 !important;
        background: white !important;
        color: black !important;
    }

    /* Force white background for all elements */
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        background: white !important;
    }
}       .hidden {
            display: none !important;
        }
        .footer {
            text-align: center;
            padding: 20px;
            background: var(--primary);
            color: white;
            font-size: 14px;
            margin-top: 30px;
            border-radius: 10px;
        }
        .patient-info-row {
            display: flex;
            margin-bottom: 8px;
        }
        .patient-info-item {
            flex: 1;
            padding: 0 10px;
        }
        .patient-info-item b {
            color: #2c3e50;
        }
        .indication-row {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .data-table td {
            padding: 6px 10px;
            border: none;
        }
        .data-table tr:nth-child(even) {
            background-color: transparent;
        }
        .echo-edit-controls {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
        }
        .echo-edit-controls.active {
            display: block;
        }
        .echo-edit-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .echo-edit-btn {
            padding: 8px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-height: 36px;
        }
        .echo-edit-btn:hover {
            background: var(--primary-dark);
        }

        /* NEW STYLES FOR CONSULTATION EDITABLE DROPDOWNS */
        .consult-edit-controls {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
        }

        .consult-edit-controls.active {
            display: block;
        }

        .consult-edit-section {
            margin-bottom: 15px;
        }

        .consult-edit-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .consult-edit-item {
            flex: 1;
            min-width: 200px;
        }

        .consult-edit-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .consult-text-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .consult-dropdown {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }

        .consult-dropdown.editable {
            border: 1px dashed #3b82f6;
            background-color: #f0f9ff;
        }

        .dropdown-edit-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .dropdown-edit-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .add-option-btn {
            background: #10b981;
            color: white;
        }

        .remove-option-btn {
            background: #ef4444;
            color: white;
        }

        .edit-option-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }

        .calendar-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .gap-line {
            padding-bottom: 10px;
        }

        /* NEW STYLES FOR CONSULTATION PRESET BUTTONS */
        .consult-preset-controls {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
        }

        .consult-preset-controls.active {
            display: block;
        }

        .consult-preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .consult-preset-btn {
            padding: 10px 15px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }

        .consult-preset-btn:hover {
            background: #7c3aed;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
        }

        /* Additional styles for editable patient details */
        .editable-patient-details {
            position: relative;
        }

        .editable-patient-details:hover {
            background-color: #f0f9ff;
            outline: 1px dashed #3b82f6;
        }

        .editable-patient-details.editing {
            background-color: #f0f9ff;
            outline: 2px solid #3b82f6;
        }

        /* Mobile Report Controls - Always Visible on Mobile */
        .mobile-report-controls {
            display: none;
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e2e8f0;
            z-index: 1000;
            padding: 10px;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 992px) {
            .mobile-report-controls {
                display: flex;
            }
            
            .report-controls {
                display: none !important;
            }
        }
        
        .mobile-report-btn {
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            min-height: 50px;
            flex: 1;
            margin: 0 5px;
            font-size: 12px;
        }
        
        .mobile-report-btn i {
            margin-bottom: 5px;
            font-size: 16px;
        }

        .mobile-report-expanded {
            display: none;
            position: fixed;
            top: 50%;
            left: 70px;
            transform: translateY(-50%);
            z-index: 1000;
            flex-direction: column;
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-height: 80vh;
            overflow-y: auto;
            width: 250px;
        }
        .mobile-report-expanded.active {
            display: flex;
        }
        .mobile-report-expanded button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: flex-start;
            min-height: 44px;
        }
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e2e8f0;
            z-index: 1000;
            padding: 5px 0;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 5px;
            text-decoration: none;
            color: var(--secondary);
            font-size: 0.7rem;
            flex: 1;
            min-height: 60px;
        }
        .bottom-nav-item.active {
            color: var(--primary);
        }
        .bottom-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }
        .follow-up-icon {
            background: #8b5cf6;
            color: white;
        }
        .follow-up-icon:hover {
            background: #7c3aed;
            transform: scale(1.05);
        }
        .see-icon {
            background: #3b82f6;
            color: white;
        }
        .see-icon:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        .follow-up-section {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .follow-up-form {
            display: none;
        }
        .follow-up-form.active {
            display: block;
        }
        .follow-up-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .follow-up-table th {
            background: #e0f2fe;
            padding: 8px 12px;
            text-align: left;
        }
        .follow-up-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        .follow-up-table tr:nth-child(even) {
            background: #f8fafc;
        }
        .follow-up-table tr:hover {
            background: #f1f5f9;
        }
        .excel-btn {
            background: #10b981;
            color: white;
        }
        .excel-btn:hover {
            background: #059669;
        }

        /* NEW STYLES FOR DIRECT EDITING */
        .editable-field {
            position: relative;
            cursor: text;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .editable-field:hover {
            background-color: #f0f9ff;
            outline: 1px dashed #3b82f6;
        }

        .editable-field.editing {
            background-color: #f0f9ff;
            outline: 2px solid #3b82f6;
        }

        .editable-input {
            width: 100%;
            border: none;
            background: transparent;
            font: inherit;
            color: inherit;
            padding: 2px 4px;
            outline: none;
        }

        .edit-hint {
            position: absolute;
            top: -20px;
            right: 0;
            background: #3b82f6;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            display: none;
        }

        .editable-field:hover .edit-hint {
            display: block;
        }

        /* Mobile number validation styling */
        .mobile-error {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .mobile-error.show {
            display: block;
        }

        /* Admin password modal */
        .admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .admin-modal.active {
            display: flex;
        }

        .admin-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .admin-modal h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .admin-modal input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .admin-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* Preset buttons styling */
        .preset-btn {
            padding: 10px 5px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
            flex: 1;
            min-width: 12px;
            justify-content: center;
        }

        .preset-btn:hover {
            background: #7c3aed;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
        }

        .echo-edit-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary);
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary);
        }

        .close:hover {
            color: var(--dark);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #e2e8f0;
        }

        /* Folder list styling */
        .folder-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .folder-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .folder-item:hover,
        .folder-item.active {
            background: #f0f9ff;
            border-color: var(--primary);
        }

        .folder-item i {
            color: var(--warning);
            font-size: 18px;
        }

        .folder-item span {
            font-weight: 500;
            color: var(--dark);
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .echo-edit-buttons {
                flex-direction: column;
            }

            .preset-btn {
                width: 100%;
            }

            .modal-content {
                width: 95%;
                margin: 20px;
            }

            /* Mobile follow-up table fixes */
            .follow-up-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .follow-up-table th,
            .follow-up-table td {
                padding: 8px 6px;
                font-size: 12px;
            }

            .follow-up-table th:nth-child(5),
            .follow-up-table td:nth-child(5) {
                min-width: 120px;
            }

            .follow-up-table th:nth-child(6),
            .follow-up-table td:nth-child(6) {
                min-width: 80px;
            }
        }

        /* New styles for file explorer simulation */
        .file-explorer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .file-explorer-modal.active {
            display: flex;
        }

        .file-explorer-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            height: 70%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .file-explorer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8f9fa;
        }

        .file-explorer-header h3 {
            margin: 0;
            color: var(--primary);
        }

        .file-explorer-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .file-explorer-path {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            padding: 8px 12px;
            background: #f1f5f9;
            border-radius: 6px;
            font-size: 14px;
        }

        .file-explorer-path i {
            color: var(--secondary);
        }

        .file-explorer-folders {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .file-explorer-folder {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
            padding: 15px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-explorer-folder:hover {
            background: #f0f9ff;
        }

        .file-explorer-folder i {
            font-size: 40px;
            color: #fbbf24;
            margin-bottom: 8px;
        }

        .file-explorer-folder span {
            font-size: 12px;
            text-align: center;
            word-break: break-word;
        }

        .file-explorer-files {
            flex: 1;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }

        .file-explorer-files-header {
            display: flex;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: var(--dark);
        }

        .file-explorer-files-header .name {
            flex: 3;
        }

        .file-explorer-files-header .date {
            flex: 2;
        }

        .file-explorer-files-header .size {
            flex: 1;
            text-align: right;
        }

        .file-explorer-files-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .file-explorer-file {
            display: flex;
            padding: 10px 15px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-explorer-file:hover {
            background: #f0f9ff;
        }

        .file-explorer-file.selected {
            background: #e0f2fe;
        }

        .file-explorer-file .name {
            flex: 3;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-explorer-file .name i {
            color: #ef4444;
        }

        .file-explorer-file .date {
            flex: 2;
            font-size: 14px;
            color: var(--secondary);
        }

        .file-explorer-file .size {
            flex: 1;
            text-align: right;
            font-size: 14px;
            color: var(--secondary);
        }

        .file-explorer-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
            background: #f8f9fa;
        }

        .file-name-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 15px;
        }

        .file-explorer-buttons {
            display: flex;
            gap: 10px;
        }

        .save-location-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #e0f2fe;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .save-location-indicator i {
            color: var(--primary);
        }

        @media print {
            .report-page {
                page-break-after: always;
                page-break-inside: avoid;
            }
            .report-page:last-child {
                page-break-after: auto;
            }
        }
        @media (max-width: 992px) {
            .sidebar {
                width: 250px;
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .sidebar-header h2,
            .sidebar-menu span {
                display: block;
            }
            .sidebar-header {
                justify-content: flex-start;
            }
            .sidebar-menu a {
                justify-content: flex-start;
                padding: 12px 20px;
            }
            .main-content {
                margin-left: 0;
                width: 100%;
                padding-bottom: 70px;
            }
            .mobile-menu-toggle {
                display: flex;
            }
            .report-controls {
                flex-direction: column;
            }
            .report-controls button {
                width: 100%;
                justify-content: center;
            }
            .report-page {
                width: 100%;
                padding: 10px;
                min-height: auto;
                box-shadow: none;
                margin-bottom: 20px;
            }
            .report-vama-striped {
                font-size: 40px;
            }
            .report-doctors {
                flex-direction: column;
            }
            .report-doctors::before {
                display: none;
            }
            .report-doctor {
                width: 100%;
                margin-bottom: 10px;
            }
            .mobile-report-controls {
                display: flex;
            }
            .report-controls {
                display: none;
            }
            .bottom-nav {
                display: flex;
            }
        }
        @media (max-width: 768px) {
            .header {
                flex-direction: row;
                gap: 15px;
                align-items: flex-start;
                padding: 15px;
            }
            .header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            .form-row {
                flex-direction: column;
                margin: 0;
            }
            .form-column {
                width: 100%;
                padding: 0;
                margin-bottom: 15px;
            }
            input,
            select,
            textarea {
                padding: 14px 12px;
            }
            .vama-striped {
                font-size: 36px;
            }
            .search-box {
                flex-direction: column;
            }
            .search-input {
                min-width: 100%;
            }
            .table-container {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            .mobile-cards {
                display: none;
            }
            .form-buttons {
                flex-direction: column;
                gap: 10px;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
            .report-vama-striped {
                font-size: 30px;
            }
            .report-header {
                flex-direction: row;
                gap: 10px;
                text-align: center;
            }
            .report-logo {
                align-self: center;
            }
            .report-header-right {
                text-align: center;
            }
            .report-doctors {
                flex-direction: row;
                gap: 10px;
            }
            .report-doctor {
                width: 100%;
                text-align: center;
            }
            .report-doctor:last-child {
                text-align: center;
            }
            .report-patient-info table {
                display: block;
            }
            .report-patient-info tr {
                display: table-row;
                margin-bottom: 0;
                padding: 0;
                background: transparent;
                border-radius: 0;
            }
            .report-patient-info td {
                display: table-cell;
                padding: 1px 2px;
                width: auto;
                border: none;
                vertical-align: top;
            }
            .report-patient-info td:first-child {
                font-weight: 600;
                color: #2c3e50;
            }
        }
        @media (max-width: 480px) {
            .main-content {
                padding: 10px;
            }
            .content {
                padding: 15px;
            }
            .header-left h1 {
                font-size: 1.5rem;
            }
            .content-header h2 {
                font-size: 1.3rem;
            }
            .user-profile span {
                display: none;
            }
            .report-vama-striped {
                font-size: 24px;
            }
            .report-clinic-name {
                font-size: 10px;
            }
            .report-doctor {
                font-size: 10px;
            }
            .report-body {
                font-size: 10px;
            }
            .registration-form {
                padding: 12px 15px;
            }
            .page-title {
                padding: 5px;
                font-size: 12px;
            }
            .vital-signs {
                padding: 15px;
            }
            .search-container {
                padding: 15px;
            }
            .echo-container,
            .appointments-container,
            .database-container {
                padding: 15px;
            }
            .bottom-nav-item {
                font-size: 0.6rem;
                padding: 5px 2px;
            }
            .bottom-nav-item i {
                font-size: 1rem;
            }
            .consult-patient-info {
                padding: 10px;
            }
            .patient-info-row {
                flex-direction: column;
                gap: 8px;
            }
            .patient-info-item {
                width: 100%;
                padding: 0;
            }
            .gap-line {
                margin: 8px 0;
                padding-bottom: 8px;
            }
        }

        /* Additional styles for validation */
        .error-message {
            color: var(--danger);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        input.error, select.error, textarea.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        
        /* NEW STYLES FOR CUSTOM BUTTON MANAGEMENT */
        .custom-buttons-controls {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
        }
        
        .custom-buttons-controls.active {
            display: block;
        }
        
        .custom-button-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .custom-button-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .custom-buttons-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .custom-button-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #e0f2fe;
            border-radius: 6px;
        }
        
        .custom-button-delete {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* Consultation report content styling */
        .consult-content {
            min-height: 300px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            background: white;
        }
        
        .consult-content.editing {
            border: 2px solid #3b82f6;
            background: #f0f9ff;
        }

        /* NEW STYLES FOR ECHO CUSTOM BUTTONS MANAGEMENT */
        .echo-custom-buttons-controls {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
        }
        
        .echo-custom-buttons-controls.active {
            display: block;
        }
        
        .echo-custom-button-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .echo-custom-button-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .echo-custom-buttons-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .echo-custom-button-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #e0f2fe;
            border-radius: 6px;
        }
        
        .echo-custom-button-delete {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Echo preset buttons styling */
        .echo-preset-btn {
            padding: 10px 15px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }

        .echo-preset-btn:hover {
            background: #7c3aed;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
        }

        .echo-edit-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* NEW STYLES FOR FIXED PATIENT NAME POSITIONING */
        .patient-name-fixed {
            display: inline-block;
            width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: top;
        }
        
        /* NEW STYLES FOR UPDATED PATIENT DETAILS IN REPORTS */
        .report-patient-info table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .report-patient-info td {
            padding: 4px 8px;
            vertical-align: top;
            border: none;
        }
        
        .report-patient-info tr:last-child td {
            border-top: 1px solid #eee;
            padding-top: 8px;
        }
        
        .report-patient-info b {
            color: #2c3e50;
            font-weight: 600;
        }
        
        /* NEW STYLES FOR ADMIN/RECEPTIONIST DIFFERENTIATION */
        .receptionist-only {
            display: none;
        }
        
        .admin-only {
            display: block;
        }
        
        .role-receptionist .admin-only {
            display: none;
        }
        
        .role-receptionist .receptionist-only {
            display: block;
        }
        
        /* Hiding action icons based on role */
        .role-receptionist .btn-echo,
        .role-receptionist .btn-consult {
            display: none !important;
        }
        
        .role-admin .btn-echo,
        .role-admin .btn-consult {
            display: inline-flex !important;
        }

        /* NEW STYLES FOR HIDING REGISTRATION PAGE FOR ADMIN */
        .role-admin .registration-only {
            display: none !important;
        }
        
        .role-receptionist .registration-only {
            display: block;
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <button class="mobile-menu-toggle" id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header"></div>
        <nav class="sidebar-menu">
            <ul>
                <li class="registration-only">
                    <a href="#" class="active" data-page="registration"
                        ><i class="fas fa-user-plus"></i> Patient Registration</a
                    >
                </li>
                <li>
                    <a href="#" data-page="appointments"
                        ><i class="fas fa-calendar-check"></i> Appointments</a
                    >
                </li>
                <li>
                    <a href="#" data-page="echo" class="admin-only"
                        ><i class="fas fa-heartbeat"></i> Echo Reports</a
                    >
                </li>
                <li>
                    <a href="#" data-page="consultation" class="admin-only"
                        ><i class="fas fa-user-md"></i> Consultation</a
                    >
                </li>
                <li>
                    <a href="#" data-page="database" class="admin-only"
                        ><i class="fas fa-database"></i> Database</a
                    >
                </li>
            </ul>
        </nav>
    </div>

    <!-- Admin Password Modal -->
    <div class="admin-modal" id="admin-modal">
        <div class="admin-modal-content">
            <h2>Admin Access</h2>
            <p>Please enter the admin password:</p>
            <input
                type="password"
                id="admin-password"
                placeholder="Enter password"
            />
            <div class="admin-modal-buttons">
                <button class="btn btn-submit" onclick="verifyAdminPassword()">
                    Submit
                </button>
                <button class="btn btn-clear" onclick="closeAdminModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- File Explorer Modal -->
    <div class="file-explorer-modal" id="file-explorer-modal">
        <div class="file-explorer-content">
            <div class="file-explorer-header">
                <h3 id="file-explorer-title">Save PDF As</h3>
                <span class="close" onclick="closeFileExplorer()">&times;</span>
            </div>
            <div class="file-explorer-body">
                <div class="save-location-indicator">
                    <i class="fas fa-folder"></i>
                    <span id="current-location"></span>
                </div>

                <div class="file-explorer-path">
                    <i class="fas fa-arrow-left" onclick="navigateUp()"></i>
                    <span id="current-path"></span>
                </div>

                <div class="file-explorer-folders" id="folders-container">
                    <!-- Folders will be populated by JavaScript -->
                </div>

                <div class="file-explorer-files">
                    <div class="file-explorer-files-header">
                        <div class="name">Name</div>
                        <div class="date">Date modified</div>
                        <div class="size">Size</div>
                    </div>
                    <div class="file-explorer-files-list" id="files-container">
                        <!-- Files will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="file-explorer-footer">
                <input
                    type="text"
                    class="file-name-input"
                    id="file-name-input"
                    placeholder="File name"
                    value="Echo_Report_John_Doe_2025-10-14.pdf"
                />
                <div class="file-explorer-buttons">
                    <button class="btn btn-clear" onclick="closeFileExplorer()">
                        Cancel
                    </button>
                    <button class="btn btn-submit" onclick="savePDFWithFileExplorer()">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Report Controls - Always Visible on Mobile -->
    <div class="mobile-report-controls" id="mobile-report-controls">
        <button class="mobile-report-btn edit-btn" onclick="toggleEchoEditMode()">
            <i class="fas fa-edit"></i>
            <span>Edit</span>
        </button>
        <button class="mobile-report-btn print-btn" onclick="printEchoReport()">
            <i class="fas fa-print"></i>
            <span>Print</span>
        </button>
        <button class="mobile-report-btn pdf-btn" onclick="saveEchoAsPDF()">
            <i class="fas fa-file-pdf"></i>
            <span>PDF</span>
        </button>
        <button class="mobile-report-btn save-btn" id="mobile-save-echo-btn" style="display: none" onclick="saveEchoReport()">
            <i class="fas fa-save"></i>
            <span>Save</span>
        </button>
    </div>

    <nav class="bottom-nav" id="bottom-nav">
        <a href="#" class="bottom-nav-item registration-only active" data-page="registration">
            <i class="fas fa-user-plus"></i>
            <span>Register</span>
        </a>
        <a href="#" class="bottom-nav-item" data-page="appointments">
            <i class="fas fa-calendar-check"></i>
            <span>Appointments</span>
        </a>
        <a href="#" class="bottom-nav-item admin-only" data-page="echo">
            <i class="fas fa-heartbeat"></i>
            <span>Echo</span>
        </a>
        <a href="#" class="bottom-nav-item admin-only" data-page="consultation">
            <i class="fas fa-user-md"></i>
            <span>Consult</span>
        </a>
        <a href="#" class="bottom-nav-item admin-only" data-page="database">
            <i class="fas fa-database"></i>
            <span>Database</span>
        </a>
    </nav>

    <div class="main-content" id="main-content">
        <header class="header">
            <div class="header-left">
                <div class="header-logo">
                    <div class="vama-striped">
                        <span class="v">V</span><span class="ama">AMA</span> <br />
                        <p class="clinic-name">TINY HEARTS & THE KIDNEY CLINIC</p>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <div class="notification-icon">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </div>
                <div class="user-profile" id="user-profile">
                    <img
                        src="https://ui-avatars.com/api/?name=Receptionist&background=10b981&color=fff"
                        alt="Receptionist"
                    />
                    <span id="user-name"
                        >Receptionist
                        <span class="role-badge role-receptionist"
                            >Receptionist</span
                        ></span
                    >
                    <div class="user-dropdown" id="user-dropdown">
                        <div class="user-dropdown-item" data-role="admin">
                            <i class="fas fa-user-shield"></i> Admin User
                        </div>
                        <div class="user-dropdown-item active" data-role="receptionist">
                            <i class="fas fa-user-tie"></i> Receptionist
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="page-container">
            <!-- Patient Registration Page - HIDDEN FOR ADMIN -->
            <div class="page registration-only active" id="registration-page">
                <div class="page-title">Patient Registration Form</div>
                <form class="registration-form" id="patientForm">
                    <!-- Patient ID and Name in 2x2 layout -->
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-column">
                                <label for="patientId">Patient ID</label>
                                <input
                                    type="text"
                                    id="patientId"
                                    name="patientId"
                                    value="5041174"
                                    readonly
                                />
                            </div>
                            <div class="form-column">
                                <label for="firstName">First Name</label>
                                <input
                                    type="text"
                                    id="firstName"
                                    name="firstName"
                                    placeholder="Enter first name"
                                    required
                                />
                                <div class="error-message" id="firstName-error">
                                    First name is required
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-column">
                                <label for="lastName">Last Name</label>
                                <input
                                    type="text"
                                    id="lastName"
                                    name="lastName"
                                    placeholder="Enter last name"
                                    required
                                />
                                <div class="error-message" id="lastName-error">
                                    Last name is required
                                </div>
                            </div>
                            <div class="form-column">
                                <label for="sex">Sex</label>
                                <select id="sex" name="sex" required>
                                    <option value="" disabled selected>Select</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                                <div class="error-message" id="sex-error">
                                    Please select a gender
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Personal Details in 2x2 layout -->
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-column">
                                <label for="dob">Date of Birth</label>
                                <input
                                    type="date"
                                    id="dob"
                                    name="dob"
                                    required
                                />
                                <div class="error-message" id="dob-error">
                                    Date of birth is required
                                </div>
                            </div>
                            <div class="form-column">
                                <label for="email">Email</label>
                                <input
                                    type="email"
                                    id="email"
                                    name="email"
                                    placeholder="Enter email"
                                />
                                <div class="error-message" id="email-error">
                                    Please enter a valid email address
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-column">
                                <label for="mobile">Mobile No</label>
                                <input
                                    type="tel"
                                    id="mobile"
                                    name="mobile"
                                    placeholder="Enter mobile number"
                                    maxlength="10"
                                    required
                                />
                                <div class="error-message" id="mobile-error">
                                    Please enter a valid 10-digit mobile number
                                </div>
                            </div>
                            <div class="form-column">
                                <label for="address">Address</label>
                                <textarea
                                    id="address"
                                    name="address"
                                    rows="3"
                                    placeholder="Enter full address"
                                    required
                                ></textarea>
                                <div class="error-message" id="address-error">
                                    Address is required
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vital Signs in 3x3 layout -->
                    <div class="vital-signs">
                        <h3 class="section-title">Vital Signs</h3>
                        <div class="form-row">
                            <div class="form-column">
                                <label for="weight">Weight (kg)</label>
                                <input
                                    type="number"
                                    id="weight"
                                    name="weight"
                                    placeholder="Enter weight"
                                    step="0.1"
                                    min="0"
                                />
                                <div class="error-message" id="weight-error">
                                    Please enter a valid weight
                                </div>
                            </div>
                            <div class="form-column">
                                <label for="height">Height (cm)</label>
                                <input
                                    type="number"
                                    id="height"
                                    name="height"
                                    placeholder="Enter height"
                                    step="0.1"
                                    min="0"
                                />
                                <div class="error-message" id="height-error">
                                    Please enter a valid height
                                </div>
                            </div>
                            <div class="form-column">
                                <label for="bloodPressure">Blood Pressure</label>
                                <input
                                    type="text"
                                    id="bloodPressure"
                                    name="bloodPressure"
                                    placeholder="e.g., 120/80"
                                />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-column">
                                <label for="heartRate">Heart Rate (BPM)</label>
                                <input
                                    type="number"
                                    id="heartRate"
                                    name="heartRate"
                                    placeholder="e.g., 72"
                                    min="0"
                                />
                            </div>
                            <div class="form-column">
                                <label for="spo2">SpO2 (%)</label>
                                <input
                                    type="number"
                                    id="spo2"
                                    name="spo2"
                                    placeholder="e.g., 98"
                                    min="0"
                                    max="100"
                                />
                            </div>
                            <div class="form-column">
                                <!-- Empty column for balance -->
                            </div>
                        </div>
                    </div>

                    <!-- Appointment Details in 2x2 layout -->
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-column">
                                <label for="appointmentDate">Date of Appointment</label>
                                <input
                                    type="date"
                                    id="appointmentDate"
                                    name="appointmentDate"
                                    required
                                />
                                <div class="error-message" id="appointmentDate-error">
                                    Appointment date is required
                                </div>
                            </div>
                            <div class="form-column">
                                <label for="appointmentTime">Time of Appointment</label>
                                <div class="time-input-container">
                                    <input
                                        type="text"
                                        id="appointmentTime"
                                        name="appointmentTime"
                                        placeholder="Type time or select from dropdown"
                                        list="timeOptions"
                                        required
                                    />
                                    <datalist id="timeOptions">
                                        <option value="06:00">6:00 AM</option>
                                        <option value="06:30">6:30 AM</option>
                                        <option value="07:00">7:00 AM</option>
                                        <option value="07:30">7:30 AM</option>
                                        <option value="08:00">8:00 AM</option>
                                        <option value="08:30">8:30 AM</option>
                                        <option value="09:00">09:00 AM</option>
                                        <option value="09:30">09:30 AM</option>
                                        <option value="10:00">10:00 AM</option>
                                        <option value="10:30">10:30 AM</option>
                                        <option value="11:00">11:00 AM</option>
                                        <option value="11:30">11:30 AM</option>
                                        <option value="12:00">12:00 PM</option>
                                        <option value="14:00">02:00 PM</option>
                                        <option value="14:30">02:30 PM</option>
                                        <option value="15:00">03:00 PM</option>
                                        <option value="15:30">03:30 PM</option>
                                        <option value="16:00">04:00 PM</option>
                                        <option value="16:30">04:30 PM</option>
                                        <option value="17:00">05:00 PM</option>
                                        <option value="17:30">05:30 PM</option>
                                        <option value="18:00">06:00 PM</option>
                                        <option value="18:30">06:30 PM</option>
                                        <option value="19:00">07:00 PM</option>
                                        <option value="19:30">07:30 PM</option>
                                        <option value="20:00">08:00 PM</option>
                                    </datalist>
                                </div>
                                <div class="error-message" id="appointmentTime-error">
                                    Appointment time is required
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-buttons">
                        <button type="submit" class="btn btn-submit">
                            <i class="fas fa-check"></i> Submit
                        </button>
                        <button type="button" class="btn btn-clear" onclick="clearForm()">
                            <i class="fas fa-times"></i> Clear Form
                        </button>
                    </div>
                </form>
            </div>

            <!-- Appointments Page -->
            <div class="page" id="appointments-page">
                <div class="page-title">Appointment Management</div>
                <div class="appointments-container">
                    <div class="search-container">
                        <div class="search-box">
                            <div class="search-input">
                                <i class="fas fa-search"></i>
                                <input
                                    type="text"
                                    id="searchPatient"
                                    placeholder="Search by name, ID, or mobile..."
                                />
                            </div>
                            <div class="search-input">
                                <select id="filterStatus">
                                    <option value="all">All Appointments</option>
                                    <option value="scheduled">Scheduled</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                    <option value="follow-up">Follow-up</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="appointments-table">
                            <thead>
                                <tr>
                                    <th>Patient ID</th>
                                    <th>Name</th>
                                    <th>Sex</th>
                                    <th>Age</th>
                                    <th>Mobile</th>
                                    <th>Appointment Date</th>
                                    <th>Appointment Time</th>
                                    <th>Status</th>
                                    <th>Next Follow-up</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="appointmentsTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Follow-up Form Section -->
                    <div class="follow-up-section">
                        <h3>Follow-up Management</h3>
                        <div class="follow-up-form" id="follow-up-form">
                            <div class="form-row">
                                <div class="form-column">
                                    <label for="follow-up-patient-id">Patient ID</label>
                                    <input type="text" id="follow-up-patient-id" readonly />
                                </div>
                                <div class="form-column">
                                    <label for="follow-up-patient-name">Patient Name</label>
                                    <input type="text" id="follow-up-patient-name" readonly />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-column">
                                    <label for="follow-up-date">Follow-up Date</label>
                                    <input type="date" id="follow-up-date" required />
                                </div>
                                <div class="form-column">
                                    <label for="follow-up-time">Follow-up Time</label>
                                    <select id="follow-up-time" required>
                                        <option value="" disabled selected>
                                            --- Select Time ---
                                        </option>
                                        <option value="09:00">09:00 AM</option>
                                        <option value="09:30">09:30 AM</option>
                                        <option value="10:00">10:00 AM</option>
                                        <option value="10:30">10:30 AM</option>
                                        <option value="11:00">11:00 AM</option>
                                        <option value="11:30">11:30 AM</option>
                                        <option value="12:00">12:00 PM</option>
                                        <option value="14:00">02:00 PM</option>
                                        <option value="14:30">02:30 PM</option>
                                        <option value="15:00">03:00 PM</option>
                                        <option value="15:30">03:30 PM</option>
                                        <option value="16:00">04:00 PM</option>
                                        <option value="16:30">04:30 PM</option>
                                        <option value="17:00">05:00 PM</option>
                                        <option value="17:30">05:30 PM</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-column">
                                    <label for="follow-up-reason">Reason for Follow-up</label>
                                    <textarea
                                        id="follow-up-reason"
                                        rows="3"
                                        placeholder="Enter reason for follow-up"
                                    ></textarea>
                                </div>
                            </div>
                            <div class="form-buttons">
                                <button
                                    type="button"
                                    class="btn btn-submit"
                                    onclick="saveFollowUp()"
                                >
                                    <i class="fas fa-check"></i> Save Follow-up
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-clear"
                                    onclick="cancelFollowUp()"
                                >
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>

                        <!-- Follow-up Table -->
                        <div class="follow-up-table-container">
                            <h4>Upcoming Follow-ups</h4>
                            <table class="follow-up-table">
                                <thead>
                                    <tr>
                                        <th>Patient ID</th>
                                        <th>Name</th>
                                        <th>Follow-up Date</th>
                                        <th>Follow-up Time</th>
                                        <th>Reason</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="follow-up-table-body">
                                    <!-- Follow-up rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Echo Reports Page -->
            <div class="page" id="echo-page">
                <div class="page-title">Echocardiography Reports</div>

                <!-- Search for Patient -->
                <div class="search-container">
                    <div class="search-box">
                        <div class="search-input">
                            <i class="fas fa-search"></i>
                            <input
                                type="text"
                                id="searchEchoPatient"
                                placeholder="Search by Patient ID or Name..."
                            />
                        </div>
                        <button class="btn btn-submit" onclick="searchEchoPatient()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>

                <!-- Echo Report Controls -->
                <div class="report-controls" id="echo-controls">
                    <button class="edit-btn" onclick="toggleEchoEditMode()">
                        <i class="fas fa-edit"></i> Edit Report
                    </button>
                    <button class="print-btn" onclick="printEchoReport()">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                    <button class="pdf-btn" onclick="saveEchoAsPDF()">
                        <i class="fas fa-file-pdf"></i> Save as PDF
                    </button>
                    <button
                        class="save-btn"
                        id="save-echo-btn"
                        style="display: none"
                        onclick="saveEchoReport()"
                    >
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>

                <!-- Echo Preset Controls -->
                <div
                    class="echo-edit-controls"
                    id="echo-preset-controls"
                    style="display: none"
                >
                    <div class="echo-edit-buttons">
                        <button class="echo-preset-btn" onclick="applyEchoPreset('Normal')">
                            <i class="fas fa-heartbeat"></i> Normal
                        </button>
                        <button class="echo-preset-btn" onclick="applyEchoPreset('ASD')">
                            <i class="fas fa-heart"></i> ASD
                        </button>
                        <button class="echo-preset-btn" onclick="applyEchoPreset('PDA')">
                            <i class="fas fa-heart"></i> PDA
                        </button>
                        <button class="echo-preset-btn" onclick="applyEchoPreset('VSD')">
                            <i class="fas fa-heart"></i> VSD
                        </button>
                        <button class="echo-preset-btn" onclick="applyEchoPreset('TOF')">
                            <i class="fas fa-heart"></i> TOF
                        </button>
                        <button class="echo-preset-btn" onclick="applyEchoPreset('AP window')">
                            <i class="fas fa-heart"></i> AP Window
                        </button>
                        <button class="echo-preset-btn" onclick="applyEchoPreset('TGA')">
                            <i class="fas fa-heart"></i> TGA
                        </button>
                        <button class="echo-preset-btn" onclick="applyEchoPreset('TAPVC')">
                            <i class="fas fa-heart"></i> TAPVC
                        </button>
                        <!-- Custom buttons will be added here dynamically -->
                    </div>
                    
                    <!-- Echo Custom Buttons Section -->
                    <div class="echo-custom-buttons-controls" id="echo-custom-buttons-controls">
                        <h4>Custom Echo Buttons</h4>
                        <div class="echo-custom-button-form">
                            <input type="text" id="echo-custom-button-name" class="echo-custom-button-input" placeholder="Button Name">
                            <textarea id="echo-custom-button-content" class="echo-custom-button-input" placeholder="Button Content"></textarea>
                            <button class="btn btn-submit" onclick="addEchoCustomButton()">
                                <i class="fas fa-plus"></i> Add Button
                            </button>
                        </div>
                        <div class="echo-custom-buttons-list" id="echo-custom-buttons-list">
                            <!-- Custom echo buttons will be added here -->
                        </div>
                    </div>
                </div>

                <!-- Report Page -->
                <div class="report-page" id="report-page">
                    <div class="report-header">
                        <div class="report-logo">
                            <span>VAMA<br />CLINIC</span>
                        </div>
                        <div class="report-vama-center">
                            <div class="report-vama-striped">
                                <span class="report-v">V</span
                                ><span class="report-ama">AMA</span>
                            </div>
                            <p class="report-clinic-name">
                                TINY HEARTS & THE KIDNEY CLINIC
                            </p>
                        </div>
                        <div class="report-header-right">
                            <div>Echocardiography Report</div>
                            <div id="report-date">Date: 12-09-2025</div>
                        </div>
                    </div>
                    <div class="report-doctors">
                        <div class="report-doctor">
                            <b>Dr. Madhavi Dadwe</b><br />
                            MBBS MD DrNB (Nephrology)<br />
                            Consultant Nephrologist & Transplant Physician<br />
                            +91 91725 20489<br />
                            vamathekidneyclinic@gmail.com
                        </div>
                        <div class="report-doctor" style="text-align: right">
                            <b>Dr. Ashishkumar Banpurkar</b><br />
                            MBBS MD DrNB (Pediatric Cardiology)<br />
                            Consultant Fetal & Pediatric Cardiologist<br />
                            +91 93709 94757<br />
                            vamatinyhearts@gmail.com
                        </div>
                    </div>
                    <!-- Patient Info - UPDATED FORMAT -->
                   
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #2c3e50;
        }
/* UPDATED PATIENT DETAILS STYLES - REDUCED GAPS AND HEIGHT */
.patient-info-container {
    max-width: 800px;
    margin: 0 auto;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 10px; /* Reduced padding */
    margin-top: 5px; /* Reduced top margin */
    margin-bottom: 5px; /* Reduced bottom margin */
}

.patient-info-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px; /* Reduced font size */
    line-height: 1.4; /* Reduced line height */
}

.patient-info-table td {
    width: 23%;
    border: 4px ;
    vertical-align: top;
}

.patient-info-table .field-label {
    font-weight: 600;
    color: #2c3e50;
    white-space: nowrap;
}

.patient-info-table .field-value {
    padding-left: 5px;
}

.section-divider {
    border-top: 1px solid #ddd;
    margin: 5px 0; /* Reduced margin */
}

.header-row {
    background-color: #e8f4fc;
    font-weight: bold;
}

/* Additional adjustments for the report page */
.report-patient-info {
    margin-top: 8px !important; /* Reduced margin */
    margin-bottom: 8px !important; /* Reduced margin */
    padding: 5px !important; /* Reduced padding */
}

.report-patient-info table {
    font-size: 12px !important; /* Reduced font size */
}

.report-patient-info td {
    padding: 2px 4px !important; /* Reduced padding */
}

/* Adjust report body spacing */
.report-body {
    margin-top: 5px !important; /* Reduced margin */
}

/* Adjust report title spacing */
.report-title {
    margin: 10px 0 8px !important; /* Reduced margins */
}
        .patient-info-table .field-label {
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
        }
        .patient-info-table .field-value {
            padding-left: 5px;
        }
        .section-divider {
            border-top: 1px solid #ddd;
            margin: 0;
        }
        .header-row {
            background-color: #e8f4fc;
            font-weight: bold;
        }
    </style>

    <div class="patient-info-container">
        <table class="patient-info-table">
            <tr>
                
                 <tr>
                <td colspan="3" style="padding: 0;">
                    <div class="section-divider"></div>
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <span class="field-label">PATIENT NAME:</span>
                    <span class="field-value editable-field" id="patient-name" contenteditable="false">John Doe</span>
                </td>
                <td width="33%">
                    <span class="field-label">REG NO:</span>
                    <span class="field-value editable-field" id="reg-no" contenteditable="false">5041174</span>
                </td>
            </tr>
            <tr>
                <td>
                    <span class="field-label">GENDER:</span>
                    <span class="field-value editable-field" id="gender" contenteditable="false">Male</span>
                </td>
                <td>
                    <span class="field-label">AGE:</span>
                    <span class="field-value editable-field" id="age" contenteditable="false">8 years</span>
                </td>
                <td>
                    <span class="field-label">DOB:</span>
                    <span class="field-value editable-field" id="dob" contenteditable="false">01-01-2017</span>
                </td>
                 <td>
                    <span class="field-label">BP:</span>
                    <span class="field-value editable-field" id="bp" contenteditable="false">110/70 mmHg</span>
                </td>
            </tr>
            <tr>
                <td colspan="3" style="padding: 0;">
                    <div class="section-divider"></div>
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <span class="field-label">ADDRESS:</span>
                    <span class="field-value editable-field" id="address" contenteditable="false">123 Main Street, City, State</span>
                </td>
                <td>
                    <span class="field-label">WEIGHT:</span>
                    <span class="field-value editable-field" id="weight" contenteditable="false">25 kg</span>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <span class="field-label">REF DR:</span>
                    <span class="field-value editable-field" id="ref-dr" contenteditable="false">Dr. Shubham Bafna</span>
                </td>
                <td>
                    <span class="field-label">HEIGHT:</span>
                    <span class="field-value editable-field" id="height" contenteditable="false">120 cm</span>
                </td>
                <td width="34%">
                    <span class="field-label">DATE:</span>
                    <span class="field-value editable-field" id="report-date" contenteditable="false">12-09-2025</span>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <span class="field-label">INDICATION:</span>
                    <span class="field-value editable-field" id="indication" contenteditable="false">Routine Checkup</span>
                </td>
                <td>
                    <span class="field-label">BMI:</span>
                    <span class="field-value editable-field" id="bmi" contenteditable="false">17.36</span>
                </td>
                 <td>
                    <span class="field-label">HR:</span>
                    <span class="field-value editable-field" id="hr" contenteditable="false">72 bpm</span>
                </td>
            </tr>
           
            <tr>
                <td colspan="3" style="padding: 0;">
                    <div class="section-divider"></div>
                </td>
            </tr>
            <tr>
                 <td>
                    <span class="field-label">SpO2:</span>
                    <span class="field-value editable-field" id="spo2" contenteditable="false">98%</span>
                </td>
                <td>
                    <span class="field-label">S1:</span>
                    <span class="field-value editable-field" id="s1" contenteditable="false">Normal</span>
                </td>
                <td>
                    <span class="field-label">S2:</span>
                    <span class="field-value editable-field" id="s2" contenteditable="false">Normal</span>
                </td>
                <td>
                    <span class="field-label">MURMUR:</span>
                    <span class="field-value editable-field" id="murmur" contenteditable="false">No Murmur</span>
                </td>
            </tr>
        </table>
    </div>

                    <div class="report-title">ECHOCARDIOGRAPHY REPORT</div>
                    <div class="report-body" id="report-body">
                        <div class="report-section">
                            <div class="section-title">Findings</div>
                            <div id="echo-diagnosis" class="editable-field" contenteditable="false">
                               
                            </div>
                        </div>
                        <div class="report-section">
                            <div class="section-title">Impression</div>
                            <div id="echo-impression" class="editable-field" contenteditable="false">
                                
                            </div>
                        </div>
                    </div>
                    <!-- Doctor signature -->
                    <div class="report-signature">
                        <b>Dr Ashishkumar Banpurkar</b><br />
                        MBBS MD DrNB (Pediatric Cardiology)<br />
                        Consultant Pediatric & Fetal Cardiologist
                    </div>
                    <!-- Footer -->
                    <div class="report-footer">
                        Vama Tiny Hearts & The Kidney Clinic | 203, 2nd Floor, City centre
                        Opp. Vaibhav Talkies, Hadapsar Pune 411028
                    </div>
                </div>
            </div>

            <!-- Consultation Page -->
            <div class="page" id="consultation-page">
                <div class="page-title">Consultation Reports</div>

                <!-- Search for Patient -->
                <div class="search-container">
                    <div class="search-box">
                        <div class="search-input">
                            <i class="fas fa-search"></i>
                            <input
                                type="text"
                                id="searchConsultPatient"
                                placeholder="Search by Patient ID or Name..."
                            />
                        </div>
                        <button class="btn btn-submit" onclick="searchConsultPatient()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>

                <!-- Consultation Report Controls -->
                <div class="report-controls" id="consult-controls">
                    <button class="edit-btn" onclick="toggleConsultEditMode()">
                        <i class="fas fa-edit"></i> Edit Report
                    </button>
                    <button class="print-btn" onclick="printConsultReport()">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                    <button class="pdf-btn" onclick="saveConsultAsPDF()">
                        <i class="fas fa-file-pdf"></i> Save as PDF
                    </button>
                    <button
                        class="save-btn"
                        id="save-consult-btn"
                        style="display: none"
                        onclick="saveConsultReport()"
                    >
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>

                <!-- Consultation Preset Controls -->
                <div class="consult-preset-controls" id="consult-preset-controls">
                    <div class="consult-preset-buttons">
                        <button class="consult-preset-btn" onclick="applyConsultPreset('RO KD')">
                            <i class="fas fa-stethoscope"></i> RO KD
                        </button>
                        <button class="consult-preset-btn" onclick="applyConsultPreset('Bicuspid Ao Valve')">
                            <i class="fas fa-heartbeat"></i> Bicuspid Ao Valve
                        </button>
                        <button class="consult-preset-btn" onclick="applyConsultPreset('PPHN Review')">
                            <i class="fas fa-lungs"></i> PPHN Review
                        </button>
                        <button class="consult-preset-btn" onclick="applyConsultPreset('CHB')">
                            <i class="fas fa-heart"></i> CHB
                        </button>
                        <button class="consult-preset-btn" onclick="applyConsultPreset('PDA')">
                            <i class="fas fa-heart"></i> PDA
                        </button>
                        <button class="consult-preset-btn" onclick="applyConsultPreset('Normal Study')">
                            <i class="fas fa-check-circle"></i> Normal Study
                        </button>
                        <button class="consult-preset-btn" onclick="applyConsultPreset('Restrictive VSD Format')">
                            <i class="fas fa-heart"></i> Restrictive VSD
                        </button>
                        <!-- Custom buttons will be added here dynamically -->
                    </div>
                    <!-- Custom Buttons Section -->
                    <div class="custom-buttons-controls" id="custom-buttons-controls">
                        <h4>Custom Buttons</h4>
                        <div class="custom-button-form">
                            <input type="text" id="custom-button-name" class="custom-button-input" placeholder="Button Name">
                            <textarea id="custom-button-content" class="custom-button-input" placeholder="Button Content"></textarea>
                            <button class="btn btn-submit" onclick="addCustomButton()">
                                <i class="fas fa-plus"></i> Add Button
                            </button>
                        </div>
                        <div class="custom-buttons-list" id="custom-buttons-list">
                            <!-- Custom buttons will be added here -->
                        </div>
                    </div>
                </div>

                <!-- Consultation Report -->
                <div class="report-page" id="consultation-report-page">
                    <div class="report-header">
                        <div class="report-logo">
                            <span>VAMA<br />CLINIC</span>
                        </div>
                        <div class="report-vama-center">
                            <div class="report-vama-striped">
                                <span class="report-v">V</span
                                ><span class="report-ama">AMA</span>
                            </div>
                            <p class="report-clinic-name">
                                TINY HEARTS & THE KIDNEY CLINIC
                            </p>
                        </div>
                        <div class="report-header-right">
                            <div>Consultant Report</div>
                            <div id="consult-report-date">Date: 12-09-2025</div>
                        </div>
                    </div>
                    <div class="report-doctors">
                        <div class="report-doctor">
                            <b>Dr. Madhavi Dadwe</b><br />
                            MBBS MD DrNB (Nephrology)<br />
                            Consultant Nephrologist & Transplant Physician<br />
                            +91 91725 20489<br />
                            vamathekidneyclinic@gmail.com
                        </div>
                        <div class="report-doctor" style="text-align: right">
                            <b>Dr. Ashishkumar Banpurkar</b><br />
                            MBBS MD DrNB (Pediatric Cardiology)<br />
                            Consultant Fetal & Pediatric Cardiologist<br />
                            +91 93709 94757<br />
                            vamatinyhearts@gmail.com
                        </div>
                    </div>
                    <!-- Patient Info with Indication - UPDATED FORMAT -->
         
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #2c3e50;
        }
        .patient-info-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            
            padding: 20px;
        }
        .patient-info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .patient-info-table td {
            
            border: 4px ;
            vertical-align: top;
        }
        .patient-info-table .field-label {
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
        }
        .patient-info-table .field-value {
            padding-left: 5px;
        }
        .section-divider {
            border-top: 1px ;
            margin: 0;
        }
        .header-row {
            background-color: #e8f4fc;
            font-weight: bold;
        }
    </style>

    <div class="patient-info-container">
        <table class="patient-info-table">
          <tr>
                
                 <tr>
                <td colspan="3" style="padding: 0;">
                    <div class="section-divider"></div>
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <span class="field-label">PATIENT NAME:</span>
                    <span class="field-value editable-field" id="consult-patient-name" contenteditable="false">John Doe</span>
                </td>
                <td width="33%">
                    <span class="field-label">REG NO:</span>
                    <span class="field-value editable-field" id="consult-reg-no" contenteditable="false">5041174</span>
                </td>
            </tr>
            <tr>
                <td>
                    <span class="field-label">GENDER:</span>
                    <span class="field-value editable-field" id="consult-gender" contenteditable="false">Male</span>
                </td>
                <td>
                    <span class="field-label">AGE:</span>
                    <span class="field-value editable-field" id="consult-age" contenteditable="false">8 years</span>
                </td>
                <td>
                    <span class="field-label">DOB:</span>
                    <span class="field-value editable-field" id="consult-dob" contenteditable="false">01-01-2017</span>
                </td>
                 <td>
                    <span class="field-label">BP:</span>
                    <span class="field-value editable-field" id="consult-bp" contenteditable="false">110/70 mmHg</span>
                </td>
                
            </tr>
            <tr>
                <td colspan="3" style="padding: 0;">
                    <div class="section-divider"></div>
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <span class="field-label">ADDRESS:</span>
                    <span class="field-value editable-field" id="consult-address" contenteditable="false">123 Main Street, City, State</span>
                </td>
                <td>
                    <span class="field-label">WEIGHT:</span>
                    <span class="field-value editable-field" id="consult-weight" contenteditable="false">25 kg</span>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <span class="field-label">REF DR:</span>
                    <span class="field-value editable-field" id="consult-ref-dr" contenteditable="false">Dr. Shubham Bafna</span>
                </td>
                <td>
                    <span class="field-label">HEIGHT:</span>
                    <span class="field-value editable-field" id="consult-height" contenteditable="false">120 cm</span>
                </td>
                <td width="34%">
                    <span class="field-label">DATE:</span>
                    <span class="field-value editable-field" id="consult-report-date-value" contenteditable="false">12-09-2025</span>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <span class="field-label">INDICATION:</span>
                    <span class="field-value editable-field" id="consult-indication" contenteditable="false">Routine Checkup</span>
                </td>
                <td>
                    <span class="field-label">BMI:</span>
                    <span class="field-value editable-field" id="consult-bmi" contenteditable="false">17.36</span>
                </td>
                <td>
                    <span class="field-label">HR:</span>
                    <span class="field-value editable-field" id="consult-hr" contenteditable="false">72 bpm</span>
                </td>
            </tr>
          
            <tr>
                <td colspan="3" style="padding: 0;">
                    <div class="section-divider"></div>
                </td>
            </tr>
            <tr>
                 <td>
                    <span class="field-label">SpO2:</span>
                    <span class="field-value editable-field" id="consult-spo2" contenteditable="false">98%</span>
                </td>
                <td>
                    <span class="field-label">S1:</span>
                    <span class="field-value editable-field" id="consult-s1" contenteditable="false">Normal</span>
                </td>
                <td>
                    <span class="field-label">S2:</span>
                    <span class="field-value editable-field" id="consult-s2" contenteditable="false">Normal</span>
                </td>
                <td>
                    <span class="field-label">MURMUR:</span>
                    <span class="field-value editable-field" id="consult-murmur" contenteditable="false">No Murmur</span>
                </td>
            </tr>
        </table>
    </div>

                    <div class="report-title">CONSULTATION REPORT</div>
                    <div class="report-body" id="consult-report-body">
                        <!-- Editable content area -->
                        <div class="consult-content" id="consult-content" contenteditable="false">
                            <!-- Content will be populated by preset buttons or custom text -->
                        </div>
                    </div>
                    <!-- Doctor signature -->
                    <div class="report-signature">
                        <b>Dr Ashishkumar M Banpurkar</b><br />
                        MBBS, MD, DNB (Pediatric Cardiology)<br />
                        Consultant Pediatric & Fetal Cardiologist
                    </div>
                    <!-- Footer -->
                    <div class="report-footer">
                        Vama Tiny Hearts & The Kidney Clinic | 203, 2nd Floor, City centre
                        Opp. Vaibhav Talkies, Hadapsar Pune 411028
                    </div>
                </div>
            </div>

            <!-- Database Page -->
            <div class="page" id="database-page">
                <div class="page-title">Patient Database</div>
                <div class="database-container">
                    <div class="search-container">
                        <div class="search-box">
                            <div class="search-input">
                                <i class="fas fa-search"></i>
                                <input
                                    type="text"
                                    id="searchDatabase"
                                    placeholder="Search by name, ID, or mobile..."
                                />
                            </div>
                            <div class="search-input">
                                <select id="filterDatabase">
                                    <option value="all">All Records</option>
                                    <option value="registration">Registration</option>
                                    <option value="echo">Echo Reports</option>
                                    <option value="consultation">Consultation</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="database-table">
                            <thead>
                                <tr>
                                    <th>Patient ID</th>
                                    <th>Name</th>
                                    <th>Sex</th>
                                    <th>Age</th>
                                    <th>Mobile</th>
                                    <th>Height</th>
                                    <th>Weight</th>
                                    <th>BMI</th>
                                    <th>Indication</th>
                                    <th>Diagnosis</th>
                                    <th>Impression</th>
                                    <th>Advise</th>
                                    <th>Next Follow Up</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="databaseTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            Vama Tiny Hearts & The Kidney Clinic | 203, 2nd Floor, City centre Opp.
            Vaibhav Talkies, Hadapsar Pune 411028
        </div>
    </div>

    <script>
       // Global variable to track current user role
let currentUserRole = "receptionist"; // Default to receptionist

// Role-based permissions
const rolePermissions = {
    receptionist: {
        mainMenu: ["registration", "appointments"],
        accessiblePages: [
            "registration",
            "appointments",
        ],
    },
    admin: {
        mainMenu: ["appointments", "echo", "consultation", "database"],
        accessiblePages: ["appointments", "echo", "consultation", "database"],
    },
};

// Initialize patients array
let patients = [];

// Echo preset data
const echoPresets = {
    Normal: {
        diagnosis: `STRUCTURALLY NORMAL HEART\n\nIntact interatrial septum<br>Intact interventricular septum<br>Laminar Inflows and Outflows<br>Normal Related Great Arteries<br>Tricuspid Aortic Valve, No AS/AR<br>Normal coronaries<br>Confluent and good sized branch pulmonary arteries<br>Left aortic arch, No CoA/PDA/LSVC<br>Good biventricular function<br>No pleural/pericardial effusion`,
        impression: "Normal Study",
    },
    ASD: {
        diagnosis: `Congenital Heart Defect<br>Large sized Ostium secundum atrial septal defect with left to right shunt<br>Dilated right atrium and left ventricle<br>Laminar Inflows<br>Mild Tricuspid Regurgitation with peak PG = mm Hg<br>Normally related great arteries<br>Confluent and good sized branch pulmonary arteries<br>Left aortic arch, No coarctation<br>No PDA, No LSVC<br>Good biventricular function`,
        impression: "Large sized Ostium secundum atrial septal defect with left to right shunt, Dilated right atrium and left ventricle, Normal Function",
    },
    PDA: {
        diagnosis: `Congenital Heart Defect<br>There is a Moderate sized patent ductus arteriosus (PDA) with left to right shunt<br>There is systolic peak gradient of mmHg and diastolic peak gradient of mmHg across the patent ductus arteriosus<br>There is mild left atrial and ventricular dilatation<br>Intact Interatrial Septum<br>Laminar Inflows and outflows<br>Normally Related Great arteries<br>Confluent and good Sized branch Pulmonary arteries<br>No mitral or tricuspid Regurgitation<br>Left arch with normal branching pattern<br>No Coarctation / No LSVC<br>Good biventricular function`,
        impression: "Moderate sized patent ductus arteriosus (PDA) with left to right shunt, Dilated left atrium and ventricle, Normal Biventricular function",
    },
    VSD: {
        diagnosis: `Congenital Heart Defect<br>Situs, Solitus, Levocardia<br>Normal systemic, pulmonary venous drainage<br>Large sized perimembranous ventricular septal defect with left to right shunt<br>Dilated Left atrium and left ventricle<br>Normally related great arteries<br>Tricuspid Aortic Valve, No AS/AR<br>Confluent and good sized branch pulmonary arteries<br>Left aortic arch, No coarctation<br>No PDA, No LSVC<br>Good biventricular function`,
        impression: "Large sized perimembranous ventricular septal defect with left to right shunt, Dilated Left atrium and left ventricle, Normal Function",
    },
    TOF: {
        diagnosis: `Congenital heart defect<br>Tetralogy of Fallot (TOF)<br>There is a large subaortic ventricular septal defect (VSD) that has bidirectional shunting across it<br>There is severe infundibular and pulmonary valvar stenosis with a peak gradient of mmHg.<br>Small ostium secundum Atrial Septal Defect with left to right shunt<br>Laminar inflows<br>No mitral or Tricuspid Regurgitation<br>Normally related great vessels<br>Tricuspid Aortic Valve, Dilated Aortic Root<br>Confluent and good sized branch pulmonary arteries<br>Normal coronaries<br>Left aortic arch, No PDA, No LSVC<br>The biventricular function appears normal.`,
        impression: "TOF, Large Subaortic VSD, Severe Valvar and infundibular Pulmonary Stenosis, Confluent and good sized branch PAs, No Coronary crossing RVOT, Normal Function",
    },
    "AP window": {
        diagnosis: `Congenital heart defect<br>There is large distal type of aortopulmonary window with left to right shunt with no gradient across AP window (peak 10mmhg)<br>Dilated left atrium and left ventricle<br>Diastolic antegrade flows seen in RPA<br>Early diastolic flow reversal in arch<br>Trivial tricuspid regurgitation with peak gradient of 50mmHg<br>Severe pulmonary hypertension<br>Intact Interatrial Septum, Intact Interventricular Septum<br>Normal Related Great Arteries<br>Normal coronaries<br>Left aortic arch, No CoA/PDA/LSVC<br>No pleural/pericardial effusion<br>Good biventricular function`,
        impression: "Large distal type of aortopulmonary window with left to right shunt , Dilated left atrium and left ventricle, Normal Function",
    },
    TGA: {
        diagnosis: `Congenital Heart Defect<br>Transposition of great arteries<br>Stretched PFO shunting left to right<br>Laminar inflows<br>No Mitral or Tricuspid Regurgitation<br>Small perimembranous VSD shunting bilaterally<br>Side by Side by Great Vessels<br>Tricuspid Aortic Valve, Tricuspid Pulmonary Valve<br>Laminar Outflows<br>Coronary artery origin 1 LCX, 2R<br>Severe Pulmonary Hypertension<br>Confluent and Dilated Branch Pulmonary Arteries<br>Tiny PDA shunting bidirectionally<br>Left Aortic Arch, No CoA/LSVC<br>Normal ventricular function`,
        impression: "Transposition of great arteries, Stretched PFO shunting left to right, Small perimembranous VSD shunting bilaterally, Tiny PDA shunting bidirectionally, 1LCx 2R, Side by Side great vessels, Normal Function",
    },
    TAPVC: {
        diagnosis: `Congenital heart defect<br>Obstructed supra cardiac Total Anomalous Pulmonary Venous Connection<br>All four pulmonary veins join a confluence and drain into innominate veins and drains into vertical vein without obstructions<br>Very small atrial septal defect with right to left shunt<br>Laminar Inflows<br>Mild Tricuspid regurgitation with peak PG =<br>No Mitral regurgitation<br>Intact interventricular Septum<br>Significantly dilated Right Atrium /Right Ventricle<br>Normally related Great Vessels<br>Tricuspid Aortic Valve, No AS/AR<br>Confluent Pulmonary Arteries<br>Severe Pulmonary hypertension<br>Left Aortic Arch, No CoA/PDA/LSVC<br>Mild Right ventricle dysfunction<br>Normal Left Ventricular function`,
        impression: "Obstructed supra cardiac Total Anomalous Pulmonary Venous Connection, Very small atrial septal defect with right to right shunt, Mild Tricuspid regurgitation with peak PG = , Significantly dilated Right Atrium /Right Ventricle, Severe Pulmonary hypertension,Mild Right ventricle dysfunction",
    },
};

// Consultation preset data
const consultPresets = {
    "RO KD": {
        content: ` Fever on and off since last 15- 20 days<br>
 No conjunctivitis/ Strawberry tongue<br>
 No respiratory distress<br>
 For cardiac Review to rule out Coronary Involvement (inflammatory Syndrome)<br><br>

 No baseline Tachycardia noted during examination <br>
 S1 S2 normal, No additional Sound<br>
 Soft Abdomen<br><br>

ECHO: Normal Study, Normal Coronary dimensions, No cuffing<br><br>

ADV:<br>
 Continue Care as per Dr Anil Chavan Sir<br>
 Review SOS <br>
 Parents Counselled`
    },
    "Bicuspid Ao Valve": {
        content: ` FT/Normal /3.080Kg/CIAB/No NICU stay<br>
 Diagnosed CHD (Bicuspid Aortic Valve, mild Aortic Stenosis)<br>
 For Cardiac Review<br>
 Recent Hospitalisation for RSV Pneumonitis for 10 days<br><br>
 Comfortable<br>
 S1 S2 normal , ESM +<br>
 Soft Abdomen<br>
 Tone Normal, Activity Normal<br><br>

ECHO: Functionally Bicuspid Aortic Valve. Mild Aortic stenosis, No Aortic Regurgitation<br><br>

ADV:
 Immunisation as per schedule<br>
 Review after 6 month<br>
 No cardiac Medications<br>
 Parents counselled`
    },
    "PPHN Review": {
        content: ` FT/Normal /3.080Kg/CIAB/No NICU stay<br>
 Diagnosed case PPHN (NICU Stay in view PPHN)<br>
 On Sildenafil<br><br>
 For Cardiac review<br>
 Feeding normal, Adequate urine output<br>
 Stable vitals<br>
 S1 S2 normal, No additional Sound<br>
 Soft Abdomen<br><br>

ECHO: Normal Study<br><br>

ADV:
 Parents Counselled<br>
 Watch for feeding/breathing difficulty<br>
 Immunisation as per schedule<br>
 Review after 3 months<br>
 Review with consultant paediatrician/Neonatologist for Ongoing Care`
    },
    "CHB": {
        content: ` Late preterm/LSCS/ AGA/Female/CIAB/Fetal bradycardia/Congenital Complete Heart Block<br>
 For Cardiac Review<br>
 Head holding +, Eye contact<br><br>
 Alert Awake,<br>
 Good Volume Pulse, Pulse Rate: 43 BPM<br>
 Soft Abdomen<br>
 Tone Normal, Activity Normal<br><br>

ECHO: Mild Mitral regurgitation, Mild Tricuspid Regurgitation, Mildly dilated left atrium and Left ventricle, Normal Biventricular function (HR 43 BPM)
<br><br>

ADV:
 Parents counselled in detail<br>
 Routine Immunisation as per schedule<br>
 Danger signs Explained , No cardiac Medications,<br>
 Early epicardial pacemaker Implantation`
    },
    "PDA": {
        content: ` PT/Normal/CIAB/ Female /Birth weight =1.5Kg/Respiratory Distress<br>
 Feeding well, Adequate urine output<br>
 Poor weight gain<br>
 Recurrent Upper respiratory infection<br>
 Stable vitals<br>
 S1 S2 normal, Continuous murmur + best over left Sub clavicular area<br>
 Soft Abdomen<br>
 Cry Tone Cativity Normal<br><br>

ECHO: ~ 2.5 mm PDA with left to right shunt, Dilated left atrium and Ventricle, Normal Function<br><br>

ADV:
 Elective PDA Device Closure<br>
 Immunisation as per schedule<br>
 Parents counselled in detail<br>
 No Cardiac Medications<br>
 Review with Dr L S kadam Sir For ongoing Care`
    },
    "Normal Study": {
        content: ` FT/LSCS/CIAB/ Female /Birth weight =3.8Kg<br>
 Acrocyanosis to rule out CHD<br>
 Feeding well, Urine passed<br>
 Stable vitals , Icterus +<br><br>
 S1 S2 normal, No additional Sound<br>
 Soft Abdomen<br>
 Cry Tone activity Normal<br>

ECHO: Normal Study<br><br>

ADV:
 No cardiac Medications<br>
 Review SOS<br>
 Immunisation as per schedule<br>
 Parents counselled<br>
 Continue care as per consultant neonatologist/Paediatrician`
    },
    "Restrictive VSD Format": {
        content: ` FT/Normal /3.080Kg/CIAB/No NICU stay<br>
 Diagnosed CHD for Review<br>
 Feeding well, Adequate urine output, weight gain+, No respiratory distress<br><br>

O/E:
 Comfortable in mother lap<br>
 CVS: S1 S2 normal, PSM+<br>
 Other System: No Significant Findings<br><br>

ECHO: Moderate sized Apical muscular Ventricular septal defect with left to right Shunt, Normal Chamber dimensions, Normal Function
<br><br>

ADV:
 Parents Counselled<br>
 Watch for feeding/breathing difficulty<br>
 Immunisation as per schedule<br>
 Review after 3 months<br>
 Review with consultant paediatrician/Neonatologist for Ongoing Care`
    }
};

// Custom buttons storage
let customButtons = [];
let echoCustomButtons = [];

// Global variables for file explorer
let currentReportType = "";
let currentLocation = "Downloads";
let currentPath = ["This PC", "Downloads"];

// File system structure simulation
const fileSystem = {
    "This PC": {
        Downloads: {
            "Echo_Report_John_Doe_2025-10-14.pdf": {
                type: "file",
                size: "245 KB",
                date: "10/14/2025 4:16 PM",
            },
            "data (1)": {
                type: "file",
                size: "1.2 MB",
                date: "10/14/2025 2:08 PM",
            },
            "Echo_5041174_John_Doe_12-09-2025": {
                type: "file",
                size: "312 KB",
                date: "10/13/2025 3:24 PM",
            },
        },
        Documents: {
            Work: { type: "folder" },
            Personal: { type: "folder" },
        },
        Desktop: {
            Projects: { type: "folder" },
            Reports: { type: "folder" },
        },
        Pictures: {
            Screenshots: { type: "folder" },
        },
    },
};

// NEW FUNCTIONS FOR ECHO CUSTOM BUTTONS MANAGEMENT
function addEchoCustomButton() {
    const name = document.getElementById('echo-custom-button-name').value.trim();
    const content = document.getElementById('echo-custom-button-content').value.trim();
    
    if (!name || !content) {
        showNotification('Please enter both button name and content', 'error');
        return;
    }
    
    // Check if button name already exists
    if (echoCustomButtons.some(btn => btn.name === name)) {
        showNotification('Button with this name already exists', 'error');
        return;
    }
    
    const newButton = {
        name: name,
        content: content
    };
    
    echoCustomButtons.push(newButton);
    saveEchoCustomButtonsToStorage();
    updateEchoCustomButtonsList();
    
    // Clear form
    document.getElementById('echo-custom-button-name').value = '';
    document.getElementById('echo-custom-button-content').value = '';
    
    showNotification('Echo custom button added successfully', 'success');
}

function deleteEchoCustomButton(buttonName) {
    if (confirm(`Are you sure you want to delete the "${buttonName}" button?`)) {
        echoCustomButtons = echoCustomButtons.filter(btn => btn.name !== buttonName);
        saveEchoCustomButtonsToStorage();
        updateEchoCustomButtonsList();
        showNotification('Echo custom button deleted successfully', 'success');
    }
}

function updateEchoCustomButtonsList() {
    const container = document.getElementById('echo-custom-buttons-list');
    container.innerHTML = '';
    
    echoCustomButtons.forEach(button => {
        const buttonElement = document.createElement('div');
        buttonElement.className = 'echo-custom-button-item';
        buttonElement.innerHTML = `
            <span>${button.name}</span>
            <button class="echo-custom-button-delete" onclick="deleteEchoCustomButton('${button.name}')">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(buttonElement);
    });
    
    // Add custom buttons to preset controls
    updateEchoPresetButtons();
}

function saveEchoCustomButtonsToStorage() {
    localStorage.setItem('vamaEchoCustomButtons', JSON.stringify(echoCustomButtons));
}

function updateEchoPresetButtons() {
    const presetContainer = document.querySelector('.echo-edit-buttons');
    
    // Remove existing custom buttons (if any)
    const existingCustomButtons = presetContainer.querySelectorAll('.echo-custom-preset-btn');
    existingCustomButtons.forEach(btn => btn.remove());
    
    // Add custom buttons
    echoCustomButtons.forEach(button => {
        const buttonElement = document.createElement('button');
        buttonElement.className = 'echo-preset-btn echo-custom-preset-btn';
        buttonElement.innerHTML = `<i class="fas fa-file-medical"></i> ${button.name}`;
        buttonElement.onclick = () => applyEchoCustomPreset(button.name);
        presetContainer.appendChild(buttonElement);
    });
}

function applyEchoCustomPreset(buttonName) {
    const button = echoCustomButtons.find(btn => btn.name === buttonName);
    if (button) {
        // Apply the content to the appropriate section based on button name
        if (buttonName.toLowerCase().includes('finding') || buttonName.toLowerCase().includes('findings')) {
            document.getElementById("echo-diagnosis").innerHTML = button.content;
        } else if (buttonName.toLowerCase().includes('impression')) {
            document.getElementById("echo-impression").innerHTML = button.content;
        } else {
            // Default behavior - apply to diagnosis
            document.getElementById("echo-diagnosis").innerHTML = button.content;
        }
        showNotification(`Echo custom preset "${buttonName}" applied successfully!`, 'success');
    }
}

// NEW FUNCTIONS FOR CUSTOM BUTTON MANAGEMENT
function addCustomButton() {
    const name = document.getElementById('custom-button-name').value.trim();
    const content = document.getElementById('custom-button-content').value.trim();
    
    if (!name || !content) {
        showNotification('Please enter both button name and content', 'error');
        return;
    }
    
    // Check if button name already exists
    if (customButtons.some(btn => btn.name === name)) {
        showNotification('Button with this name already exists', 'error');
        return;
    }
    
    const newButton = {
        name: name,
        content: content
    };
    
    customButtons.push(newButton);
    saveCustomButtonsToStorage();
    updateCustomButtonsList();
    
    // Clear form
    document.getElementById('custom-button-name').value = '';
    document.getElementById('custom-button-content').value = '';
    
    showNotification('Custom button added successfully', 'success');
}

function deleteCustomButton(buttonName) {
    if (confirm(`Are you sure you want to delete the "${buttonName}" button?`)) {
        customButtons = customButtons.filter(btn => btn.name !== buttonName);
        saveCustomButtonsToStorage();
        updateCustomButtonsList();
        showNotification('Custom button deleted successfully', 'success');
    }
}

function updateCustomButtonsList() {
    const container = document.getElementById('custom-buttons-list');
    container.innerHTML = '';
    
    customButtons.forEach(button => {
        const buttonElement = document.createElement('div');
        buttonElement.className = 'custom-button-item';
        buttonElement.innerHTML = `
            <span>${button.name}</span>
            <button class="custom-button-delete" onclick="deleteCustomButton('${button.name}')">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(buttonElement);
    });
    
    // Add custom buttons to preset controls
    updateConsultPresetButtons();
}

function saveCustomButtonsToStorage() {
    localStorage.setItem('vamaCustomButtons', JSON.stringify(customButtons));
}

function updateConsultPresetButtons() {
    const presetContainer = document.querySelector('.consult-preset-buttons');
    
    // Remove existing custom buttons (if any)
    const existingCustomButtons = presetContainer.querySelectorAll('.custom-preset-btn');
    existingCustomButtons.forEach(btn => btn.remove());
    
    // Add custom buttons
    customButtons.forEach(button => {
        const buttonElement = document.createElement('button');
        buttonElement.className = 'consult-preset-btn custom-preset-btn';
        buttonElement.innerHTML = `<i class="fas fa-file-medical"></i> ${button.name}`;
        buttonElement.onclick = () => applyCustomPreset(button.name);
        presetContainer.appendChild(buttonElement);
    });
}

function applyCustomPreset(buttonName) {
    const button = customButtons.find(btn => btn.name === buttonName);
    if (button) {
        document.getElementById('consult-content').innerHTML = button.content;
        showNotification(`Custom preset "${buttonName}" applied successfully!`, 'success');
    }
}

// NEW FUNCTIONS FOR CONSULTATION REPORT CONTROLS
let consultEditMode = false;
let originalConsultContent = {};

function toggleConsultEditMode() {
    consultEditMode = !consultEditMode;
    const saveBtn = document.getElementById("save-consult-btn");
    const editBtn = document.querySelector("#consult-controls .edit-btn");
    const presetControls = document.getElementById("consult-preset-controls");
    const customControls = document.getElementById("custom-buttons-controls");
    const consultContent = document.getElementById("consult-content");

    if (consultEditMode) {
        // Enter edit mode
        enableConsultEditing();
        saveBtn.style.display = "flex";
        editBtn.innerHTML = '<i class="fas fa-times"></i> Cancel Edit';
        editBtn.style.background = "#6c757d";
        presetControls.classList.add("active");
        customControls.classList.add("active");
        consultContent.contentEditable = true;
        consultContent.classList.add("editing");
        showNotification(
            "Consultation report editing enabled. Use the preset buttons or edit directly in the content area.",
            "info"
        );
    } else {
        // Exit edit mode
        disableConsultEditing();
        saveBtn.style.display = "none";
        editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Report';
        editBtn.style.background = "";
        presetControls.classList.remove("active");
        customControls.classList.remove("active");
        consultContent.contentEditable = false;
        consultContent.classList.remove("editing");
        showNotification("Edit mode cancelled.", "info");
    }
}

function enableConsultEditing() {
    // Store original content
    originalConsultContent = {
        content: document.getElementById("consult-content").innerHTML
    };

    // Make all patient details editable
    document.querySelectorAll('#consultation-report-page .editable-field').forEach(element => {
        element.contentEditable = true;
        element.style.border = "1px dashed #3b82f6";
        element.style.padding = "2px 4px";
        element.style.borderRadius = "4px";
        element.style.backgroundColor = "#f0f9ff";
    });
}

function disableConsultEditing() {
    // Restore original content if cancelled
    if (Object.keys(originalConsultContent).length > 0) {
        document.getElementById("consult-content").innerHTML = originalConsultContent.content;
    }

    // Remove patient details editing
    document.querySelectorAll('#consultation-report-page .editable-field').forEach(element => {
        element.contentEditable = false;
        element.style.border = "none";
        element.style.padding = "0";
        element.style.borderRadius = "0";
        element.style.backgroundColor = "transparent";
    });

    consultEditMode = false;
}

async function saveConsultReport() {
    try {
        // Get patient ID
        const patientId = document.getElementById("consult-reg-no").textContent.trim();
        
        if (!patientId || patientId === 'N/A') {
            showNotification("Please search for a patient first.", "error");
            return;
        }

        // Create consultation report object
        const consultationReport = {
            patientId: patientId,
            reportDate: new Date().toISOString().split('T')[0],
            content: document.getElementById("consult-content").innerHTML,
            indication: document.getElementById("consult-indication").textContent,
            advise: "Continue current treatment",
            nextFollowUp: "1 month"
        };

        console.log(' Saving consultation report:', consultationReport);

        // Save to database via API
        const response = await apiCall('/api/consultation-reports', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(consultationReport)
        });

        console.log(' Consultation report save response:', response);

        if (response && response.success) {
            // Update local data
            const patient = findPatient(patientId);
            if (patient) {
                if (!patient.consultations) patient.consultations = [];
                patient.consultations.push(consultationReport);
            }

            showNotification(" Consultation report saved successfully!", "success");
            toggleConsultEditMode();
        } else {
            throw new Error(response.error || 'Failed to save report');
        }

    } catch (error) {
        console.error(' Save failed:', error);
        showNotification(" Save failed: " + error.message, "error");
    }
}

// NEW FUNCTIONS FOR ECHO REPORT CONTROLS
let echoEditMode = false;
let originalEchoContent = {};

function toggleEchoEditMode() {
    echoEditMode = !echoEditMode;
    const saveBtn = document.getElementById("save-echo-btn");
    const mobileSaveBtn = document.getElementById("mobile-save-echo-btn");
    const editBtn = document.querySelector("#echo-controls .edit-btn");
    const presetControls = document.getElementById("echo-preset-controls");
    const customControls = document.getElementById("echo-custom-buttons-controls");

    if (echoEditMode) {
        // Enter edit mode
        enableEchoEditing();
        saveBtn.style.display = "flex";
        mobileSaveBtn.style.display = "flex";
        editBtn.innerHTML = '<i class="fas fa-times"></i> Cancel Edit';
        editBtn.style.background = "#6c757d";
        presetControls.style.display = "block";
        customControls.classList.add("active");
        showNotification(
            "Echo report editing enabled. Use the preset buttons or edit directly in the content area.",
            "info"
        );
    } else {
        // Exit edit mode
        disableEchoEditing();
        saveBtn.style.display = "none";
        mobileSaveBtn.style.display = "none";
        editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Report';
        editBtn.style.background = "";
        presetControls.style.display = "none";
        customControls.classList.remove("active");
        showNotification("Edit mode cancelled.", "info");
    }
}

function enableEchoEditing() {
    // Store original content
    originalEchoContent = {
        diagnosis: document.getElementById("echo-diagnosis").innerHTML,
        impression: document.getElementById("echo-impression").innerHTML,
    };

    // Make all patient details and content editable
    document.querySelectorAll('#report-page .editable-field').forEach(element => {
        element.contentEditable = true;
        element.style.border = "1px dashed #3b82f6";
        element.style.padding = "2px 4px";
        element.style.borderRadius = "4px";
        element.style.backgroundColor = "#f0f9ff";
    });
}

function disableEchoEditing() {
    // Restore original content if cancelled
    if (Object.keys(originalEchoContent).length > 0) {
        document.getElementById("echo-diagnosis").innerHTML =
            originalEchoContent.diagnosis;
        document.getElementById("echo-impression").innerHTML =
            originalEchoContent.impression;
    }

    // Remove editing capabilities
    document.querySelectorAll('#report-page .editable-field').forEach(element => {
        element.contentEditable = false;
        element.style.border = "none";
        element.style.padding = "0";
        element.style.borderRadius = "0";
        element.style.backgroundColor = "transparent";
    });

    echoEditMode = false;
}

async function saveEchoReport() {
    try {
        const patientId = document.getElementById("reg-no").textContent.trim();
        
        if (!patientId || patientId === 'N/A') {
            showNotification("Please search for a patient first.", "error");
            return;
        }

        const echoReport = {
            patientId: patientId,
            reportDate: new Date().toISOString().split('T')[0],
            diagnosis: document.getElementById("echo-diagnosis").innerHTML || '',
            impression: document.getElementById("echo-impression").innerHTML || '',
            indication: document.getElementById("indication").textContent || 'Routine Checkup',
            refDr: document.getElementById("ref-dr").textContent || 'Dr. Shubham Bafna',
            advise: "Follow-up as advised",
            nextFollowUp: "3 months"
        };

        console.log(' Saving echo report:', echoReport);

        const response = await apiCall('/api/echo-reports', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(echoReport)
        });

        console.log(' Echo report save response:', response);

        if (response && response.success) {
            // Update local data
            const patient = findPatient(patientId);
            if (patient) {
                if (!patient.echoReports) patient.echoReports = [];
                patient.echoReports.push(echoReport);
            }
            
            showNotification(" Echo report saved successfully!", "success");
            toggleEchoEditMode();
        } else {
            throw new Error(response.error || 'Failed to save report');
        }

    } catch (error) {
        console.error(' Save failed:', error);
        showNotification(" Save failed: " + error.message, "error");
    }
}

// Function to apply echo preset with proper formatting
function applyEchoPreset(presetName) {
    if (!echoEditMode) {
        showNotification("Please enable edit mode first.", "error");
        return;
    }

    const preset = echoPresets[presetName];
    if (preset) {
        document.getElementById("echo-diagnosis").innerHTML = preset.diagnosis;
        document.getElementById("echo-impression").innerHTML = preset.impression;
        showNotification(`${presetName} preset applied successfully!`, 'success');
    }
}

// NEW FUNCTION TO APPLY CONSULTATION PRESETS
function applyConsultPreset(presetName) {
    if (!consultEditMode) {
        showNotification("Please enable edit mode first.", "error");
        return;
    }

    const preset = consultPresets[presetName];
    if (preset) {
        document.getElementById("consult-content").innerHTML = preset.content;
        showNotification(`${presetName} preset applied successfully!`, 'success');
    }
}

// Function to clean up echo report content before printing
function cleanEchoContentForPrint() {
    // Ensure all paragraphs have no margins
    const diagnosisParagraphs = document.querySelectorAll('#echo-diagnosis p');
    const impressionParagraphs = document.querySelectorAll('#echo-impression p');
    
    diagnosisParagraphs.forEach(p => {
        p.style.margin = '0';
        p.style.padding = '0';
        p.style.lineHeight = '1';
    });
    
    impressionParagraphs.forEach(p => {
        p.style.margin = '0';
        p.style.padding = '0';
        p.style.lineHeight = '1';
    });
}

// Update the print function
function printEchoReport() {
    // Clean up content before printing
    cleanEchoContentForPrint();
    
    const reportElement = document.getElementById("report-page");
    const printClone = reportElement.cloneNode(true);

    // Hide elements that shouldn't be printed
    const elementsToHide = printClone.querySelectorAll(
        ".report-header, .report-footer, .report-doctors"
    );

    elementsToHide.forEach((el) => {
        el.style.display = "none";
        el.style.visibility = "hidden";
    });

    // Show only patient details and doctor signature
    const elementsToShow = printClone.querySelectorAll(
        ".report-patient-info, .report-signature"
    );

    elementsToShow.forEach((el) => {
        el.style.display = "block";
        el.style.visibility = "visible";
    });

    // Ensure report body content is visible
    const reportBody = printClone.querySelector(".report-body");
    if (reportBody) {
        reportBody.style.display = "block";
        reportBody.style.visibility = "visible";
        reportBody.style.marginTop = "5px";
    }

    // Create a temporary container for printing
    const printContainer = document.createElement("div");
    printContainer.style.cssText = `
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 10000;
        padding: 10mm;
        overflow: auto;
        font-size: 11pt;
        line-height: 1;
    `;
    
    // Add minimal gap at the top
    const gapElement = document.createElement("div");
    gapElement.style.cssText = `
        height: 2em;
        width: 100%;
        margin-bottom: 5px;
    `;
    printContainer.appendChild(gapElement);
    printContainer.appendChild(printClone);

    document.body.appendChild(printContainer);

    // Print and then remove the temporary container
    window.print();

    setTimeout(() => {
        if (printContainer.parentNode) {
            document.body.removeChild(printContainer);
        }
    }, 500);
}

function printConsultReport() {
    // Create a temporary print-friendly version
    const reportElement = document.getElementById("consultation-report-page");
    const printClone = reportElement.cloneNode(true);

    // Hide elements that shouldn't be printed (headers and footers)
    const elementsToHide = printClone.querySelectorAll(
        ".report-header, .report-footer, .report-doctors"
    );

    elementsToHide.forEach((el) => {
        el.style.display = "none";
        el.style.visibility = "hidden";
    });

    // Show only patient details and doctor signature
    const elementsToShow = printClone.querySelectorAll(
        ".report-patient-info, .report-signature, .consult-patient-info"
    );

    elementsToShow.forEach((el) => {
        el.style.display = "block";
        el.style.visibility = "visible";
    });

    // Show the report body content
    const reportBody = printClone.querySelector(".report-body");
    if (reportBody) {
        reportBody.style.display = "block";
        reportBody.style.visibility = "visible";
        reportBody.style.marginTop = "20px";
    }

    // Ensure report title is visible
    const reportTitle = printClone.querySelector(".report-title");
    if (reportTitle) {
        reportTitle.style.display = "block";
        reportTitle.style.visibility = "visible";
    }

    // Create a temporary container for printing
    const printContainer = document.createElement("div");
    printContainer.style.cssText = `
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 10000;
        padding: 15mm 0mm 4mm 0mm;
        overflow: auto;
        font-size: 12pt;
    `;
    
    // Add 15 line gap at the top
    const gapElement = document.createElement("div");
    gapElement.style.cssText = `
        height: 15em; /* Approximately 15 lines */
        width: 100%;
        margin-bottom: 20px;
    `;
    printContainer.appendChild(gapElement);
    printContainer.appendChild(printClone);

    document.body.appendChild(printContainer);

    // Print and then remove the temporary container
    window.print();

    setTimeout(() => {
        if (printContainer.parentNode) {
            document.body.removeChild(printContainer);
        }
    }, 500);
}

// Function to save Consultation Report as PDF with file explorer
async function saveConsultAsPDF() {
    try {
        // Store current edit mode state
        const wasInEditMode = consultEditMode;

        // If in edit mode, exit it temporarily for PDF generation
        if (wasInEditMode) {
            disableConsultEditing();
        }

        // Show file explorer modal
        showFileExplorer("consultation");
    } catch (error) {
        console.error("Error in PDF generation:", error);
        showNotification("Error generating PDF. Please try again.", "error");

        // Restore edit mode if it was active
        if (wasInEditMode) {
            setTimeout(() => {
                toggleConsultEditMode();
            }, 500);
        }
    }
}

// Quick PDF Save without file explorer (patient details hidden)
function quickSavePDF() {
    const reportType = document.getElementById("echo-page").classList.contains("active") ? "echo" : "consultation";
    
    if (reportType === "echo") {
        saveEchoAsPDF();
    } else {
        saveConsultAsPDF();
    }
}
async function savePDFSimple() {
    try {
        showNotification("Generating PDF... Please wait.", "info");

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("p", "mm", "a4");

        // Get the report element
        const reportElement = document.getElementById("report-page");
        
        // Create a clone
        const reportClone = reportElement.cloneNode(true);

        // HIDE ALL PATIENT DETAILS
        const patientDetails = reportClone.querySelector(".patient-info-container");
        const reportHeader = reportClone.querySelector(".report-header");
        const reportDoctors = reportClone.querySelector(".report-doctors");
        const reportFooter = reportClone.querySelector(".report-footer");
        const reportSignature = reportClone.querySelector(".report-signature");

        // Hide these elements
        if (patientDetails) patientDetails.style.display = "none";
        if (reportHeader) reportHeader.style.display = "none";
        if (reportDoctors) reportDoctors.style.display = "none";
        if (reportFooter) reportFooter.style.display = "none";
        if (reportSignature) reportSignature.style.display = "none";

        // Show only report title and content
        const reportTitle = reportClone.querySelector(".report-title");
        const reportBody = reportClone.querySelector(".report-body");

        if (reportTitle) {
            reportTitle.style.marginTop = "20mm";
            reportTitle.style.marginBottom = "10mm";
        }

        if (reportBody) {
            reportBody.style.marginTop = "0";
            reportBody.style.marginBottom = "0";
        }

        // Append to body temporarily
        reportClone.style.position = "absolute";
        reportClone.style.left = "-9999px";
        reportClone.style.top = "0";
        document.body.appendChild(reportClone);

        const canvas = await html2canvas(reportClone, {
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: "#ffffff",
        });

        document.body.removeChild(reportClone);

        const imgData = canvas.toDataURL("image/png");
        const imgWidth = 210;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        doc.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
        
        // Generate filename
        const patientId = document.getElementById("reg-no").textContent || "unknown";
        const patientName = document.getElementById("patient-name").textContent || "report";
        const fileName = `Report_${patientId}_${patientName.replace(/\s+/g, "_")}.pdf`;
        
        doc.save(fileName);
        showNotification("PDF saved successfully!", "success");

    } catch (error) {
        console.error("Error generating PDF:", error);
        showNotification("Error generating PDF.", "error");
    }
}
// Function to save Echo Report as PDF with file explorer
async function saveEchoAsPDF() {
    try {
        // Store current edit mode state
        const wasInEditMode = echoEditMode;

        // If in edit mode, exit it temporarily for PDF generation
        if (wasInEditMode) {
            disableEchoEditing();
        }

        // Show file explorer modal
        showFileExplorer("echo");
    } catch (error) {
        console.error("Error in PDF generation:", error);
        showNotification("Error generating PDF. Please try again.", "error");

        // Restore edit mode if it was active
        if (wasInEditMode) {
            setTimeout(() => {
                toggleEchoEditMode();
            }, 500);
        }
    }
}

// File Explorer Functions
function showFileExplorer(reportType) {
    currentReportType = reportType;
    const modal = document.getElementById("file-explorer-modal");
    const modalTitle = document.getElementById("file-explorer-title");

    // Set modal title based on report type
    modalTitle.textContent = `Save ${
        reportType === "echo" ? "Echo" : "Consultation"
    } Report As`;

    // Reset to default location
    currentLocation = "Downloads";
    currentPath = ["This PC", "Downloads"];

    // Generate filename based on patient info
    let fileName = "";
    if (reportType === "echo") {
        const patientId =
            document.getElementById("reg-no").textContent || "unknown";
        const patientName =
            document.getElementById("patient-name").textContent ||
            "echo_report";
        const reportDate =
            document
                .getElementById("report-date")
                .textContent.replace("Date: ", "") ||
            new Date().toISOString().split("T")[0];
        fileName = `Echo_${patientId}_${patientName.replace(
            /\s+/g, "_"
        )}_${reportDate.replace(/\//g, "-")}.pdf`;
    } else {
        const patientId =
            document.getElementById("consult-reg-no").textContent ||
            "unknown";
        const patientName =
            document.getElementById("consult-patient-name").textContent ||
            "consult_report";
        const reportDate =
            document.getElementById("consult-report-date-value").textContent ||
            new Date().toISOString().split("T")[0];
        fileName = `Consult_${patientId}_${patientName.replace(
            /\s+/g, "_"
        )}_${reportDate.replace(/\//g, "-")}.pdf`;
    }

    document.getElementById("file-name-input").value = fileName;

    // Update the file explorer view
    updateFileExplorerView();

    // Show the modal
    modal.classList.add("active");
}

function closeFileExplorer() {
    document
        .getElementById("file-explorer-modal")
        .classList.remove("active");
}

function updateFileExplorerView() {
    // Update path display
    document.getElementById("current-path").textContent =
        currentPath.join(" > ");
    document.getElementById("current-location").textContent =
        currentPath.join(" > ");

    // Get current location in file system
    let currentLocationData = fileSystem;
    for (const pathPart of currentPath) {
        if (currentLocationData[pathPart]) {
            currentLocationData = currentLocationData[pathPart];
        }
    }

    // Clear containers
    const foldersContainer = document.getElementById("folders-container");
    const filesContainer = document.getElementById("files-container");
    foldersContainer.innerHTML = "";
    filesContainer.innerHTML = "";

    // Add folders
    Object.keys(currentLocationData).forEach((key) => {
        if (currentLocationData[key].type === "folder") {
            const folderElement = document.createElement("div");
            folderElement.className = "file-explorer-folder";
            folderElement.innerHTML = `
                <i class="fas fa-folder"></i>
                <span>${key}</span>
            `;
            folderElement.onclick = () => navigateToFolder(key);
            foldersContainer.appendChild(folderElement);
        }
    });

    // Add files
    Object.keys(currentLocationData).forEach((key) => {
        if (currentLocationData[key].type === "file") {
            const fileElement = document.createElement("div");
            fileElement.className = "file-explorer-file";
            fileElement.innerHTML = `
                <div class="name">
                    <i class="fas fa-file-pdf"></i>
                    <span>${key}</span>
                </div>
                <div class="date">${currentLocationData[key].date}</div>
                <div class="size">${currentLocationData[key].size}</div>
            `;
            fileElement.onclick = () => {
                // Remove selection from all files
                document
                    .querySelectorAll(".file-explorer-file")
                    .forEach((file) => {
                        file.classList.remove("selected");
                    });
                // Add selection to clicked file
                fileElement.classList.add("selected");
                // Set filename to selected file
                document.getElementById("file-name-input").value = key;
            };
            filesContainer.appendChild(fileElement);
        }
    });

    // If no folders or files, show message
    if (
        foldersContainer.children.length === 0 &&
        filesContainer.children.length === 0
    ) {
        foldersContainer.innerHTML =
            '<p style="text-align: center; color: var(--secondary); width: 100%;">This folder is empty</p>';
    }
}

function navigateToFolder(folderName) {
    currentPath.push(folderName);
    updateFileExplorerView();
}

function navigateUp() {
    if (currentPath.length > 2) {
        // Don't navigate above "This PC"
        currentPath.pop();
        updateFileExplorerView();
    }
}

// Enhanced PDF generation with file explorer - HIDING HEADERS, FOOTERS & PATIENT DETAILS
async function savePDFWithFileExplorer() {
    const fileName = document.getElementById("file-name-input").value;
    if (!fileName) {
        showNotification("Please enter a file name.", "error");
        return;
    }

    // Ensure the filename has .pdf extension
    const finalFileName = fileName.endsWith(".pdf")
        ? fileName
        : `${fileName}.pdf`;

    try {
        showNotification("Generating PDF... Please wait.", "info");

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("p", "mm", "a4");

        // Get the report element based on report type
        const reportElement =
            currentReportType === "echo"
                ? document.getElementById("report-page")
                : document.getElementById("consultation-report-page");

        // Create a clone of the report element
        const reportClone = reportElement.cloneNode(true);

        // HIDE HEADERS, FOOTERS, AND PATIENT DETAILS
        const elementsToHide = reportClone.querySelectorAll(
            ".report-header, .report-doctors, .report-footer, " +
            ".report-patient-info, .patient-info-container, " +
            ".report-signature, .patient-info-container"
        );

        elementsToHide.forEach((el) => {
            el.style.display = "none";
            el.style.visibility = "hidden";
            el.style.height = "0";
            el.style.margin = "0";
            el.style.padding = "0";
            el.style.opacity = "0";
            el.style.position = "absolute";
            el.style.left = "-9999px";
        });

        // Show only the report content
        const reportTitle = reportClone.querySelector(".report-title");
        const reportBody = reportClone.querySelector(".report-body");
        const echoDiagnosis = reportClone.querySelector("#echo-diagnosis");
        const echoImpression = reportClone.querySelector("#echo-impression");
        const consultContent = reportClone.querySelector(".consult-content");

        // Style the visible elements for better PDF presentation
        if (reportTitle) {
            reportTitle.style.display = "block";
            reportTitle.style.visibility = "visible";
            reportTitle.style.marginTop = "20mm";
            reportTitle.style.marginBottom = "10mm";
            reportTitle.style.textAlign = "center";
            reportTitle.style.fontSize = "16pt";
            reportTitle.style.fontWeight = "bold";
        }

        if (reportBody) {
            reportBody.style.display = "block";
            reportBody.style.visibility = "visible";
            reportBody.style.marginTop = "5mm";
            reportBody.style.marginBottom = "5mm";
            reportBody.style.padding = "0";
        }

        if (echoDiagnosis) {
            echoDiagnosis.style.display = "block";
            echoDiagnosis.style.visibility = "visible";
            echoDiagnosis.style.margin = "5mm 0";
            echoDiagnosis.style.padding = "0";
        }

        if (echoImpression) {
            echoImpression.style.display = "block";
            echoImpression.style.visibility = "visible";
            echoImpression.style.margin = "5mm 0";
            echoImpression.style.padding = "0";
        }

        if (consultContent) {
            consultContent.style.display = "block";
            consultContent.style.visibility = "visible";
            consultContent.style.marginTop = "5mm";
            consultContent.style.marginBottom = "5mm";
            consultContent.style.padding = "0";
            consultContent.style.border = "none";
            consultContent.style.background = "transparent";
        }

        // Remove any edit controls or buttons
        const elementsToRemove = reportClone.querySelectorAll(
            ".echo-edit-controls, .consult-edit-controls, " +
            ".report-controls, .mobile-report-controls, " +
            ".edit-hint, .action-icons, .btn"
        );
        elementsToRemove.forEach(el => el.remove());

        // Set up the clone for PDF generation
        reportClone.style.width = "210mm";
        reportClone.style.minHeight = "297mm";
        reportClone.style.background = "white";
        reportClone.style.padding = "10mm";
        reportClone.style.margin = "0";
        reportClone.style.boxSizing = "border-box";
        reportClone.style.position = "absolute";
        reportClone.style.left = "0";
        reportClone.style.top = "0";

        // Ensure proper text styling
        const allTextElements = reportClone.querySelectorAll('*');
        allTextElements.forEach(el => {
            el.style.color = "#000000";
            el.style.backgroundColor = "transparent";
            el.style.boxShadow = "none";
            if (!el.classList.contains('report-title')) {
                el.style.border = "none";
            }
        });

        // Append to body for capture
        const tempContainer = document.createElement('div');
        tempContainer.style.position = "fixed";
        tempContainer.style.left = "0";
        tempContainer.style.top = "0";
        tempContainer.style.width = "210mm";
        tempContainer.style.height = "297mm";
        tempContainer.style.background = "white";
        tempContainer.style.zIndex = "9999";
        tempContainer.style.overflow = "hidden";
        
        tempContainer.appendChild(reportClone);
        document.body.appendChild(tempContainer);

        // Calculate dimensions
        const pageWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        const margin = 10; // 10mm margins

        // Capture the content
        const canvas = await html2canvas(reportClone, {
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: "#ffffff",
            width: reportClone.scrollWidth,
            height: reportClone.scrollHeight,
            scrollX: 0,
            scrollY: 0,
            windowWidth: reportClone.scrollWidth,
            windowHeight: reportClone.scrollHeight
        });

        // Clean up
        document.body.removeChild(tempContainer);

        const imgData = canvas.toDataURL("image/png");
        
        // Calculate image dimensions to fit A4 with margins
        const imgWidth = pageWidth - (2 * margin);
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        let currentHeight = 0;
        let pageNumber = 1;

        // Function to add a page
        const addPageToPDF = (imgData, startY, height, isFirstPage = false) => {
            if (isFirstPage) {
                // First page - add image normally
                doc.addImage(imgData, "PNG", margin, margin, imgWidth, imgHeight);
            } else {
                // Subsequent pages - add with cropping
                const srcHeight = (height * canvas.height) / imgHeight;
                const srcY = ((currentHeight - height) * canvas.height) / imgHeight;
                
                doc.addImage(
                    imgData,
                    "PNG",
                    margin, // x
                    margin, // y
                    imgWidth, // width
                    height, // height
                    0, // srcX
                    srcY, // srcY
                    canvas.width, // srcWidth
                    srcHeight // srcHeight
                );
            }
        };

        // Handle multi-page content
        if (imgHeight <= (pageHeight - (2 * margin))) {
            // Single page
            addPageToPDF(imgData, margin, imgHeight, true);
        } else {
            // Multiple pages needed
            let remainingHeight = imgHeight;
            let currentPosition = 0;
            
            while (remainingHeight > 0) {
                if (pageNumber > 1) {
                    doc.addPage();
                }
                
                const pageContentHeight = pageHeight - (2 * margin);
                const contentHeight = Math.min(remainingHeight, pageContentHeight);
                
                addPageToPDF(imgData, margin, contentHeight, pageNumber === 1);
                
                // Add page number
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(
                    `Page ${pageNumber}`,
                    pageWidth / 2,
                    pageHeight - 5,
                    { align: 'center' }
                );
                
                remainingHeight -= pageContentHeight;
                currentPosition += pageContentHeight;
                pageNumber++;
            }
        }

        // Save the PDF
        if ("showSaveFilePicker" in window) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: finalFileName,
                    types: [
                        {
                            description: "PDF Files",
                            accept: { "application/pdf": [".pdf"] },
                        },
                    ],
                });

                const writable = await fileHandle.createWritable();
                const pdfBlob = doc.output("blob");
                await writable.write(pdfBlob);
                await writable.close();

                showNotification(
                    `Report saved successfully as ${finalFileName}!`,
                    "success"
                );
                closeFileExplorer();
            } catch (saveError) {
                if (saveError.name !== "AbortError") {
                    doc.save(finalFileName);
                    showNotification(
                        `Report saved as ${finalFileName}!`,
                        "success"
                    );
                    closeFileExplorer();
                }
            }
        } else {
            doc.save(finalFileName);
            showNotification(`Report saved as ${finalFileName}!`, "success");
            closeFileExplorer();
        }

    } catch (error) {
        console.error("Error generating PDF:", error);
        showNotification("Error generating PDF. Please try again.", "error");
        
        // Clean up any remaining elements
        const remainingElements = document.querySelectorAll('[style*="fixed"]');
        remainingElements.forEach(el => {
            if (el.parentNode) {
                el.parentNode.removeChild(el);
            }
        });
    }
}

// Function to save patients data to localStorage
function savePatientsToStorage() {
    localStorage.setItem("vamaPatients", JSON.stringify(patients));
}

// Function to update UI based on user role
function updateUIForUserRole() {
    const adminOnlyElements = document.querySelectorAll(".admin-only");
    const registrationOnlyElements = document.querySelectorAll(".registration-only");
    const isAdmin = currentUserRole === "admin";
    const permissions = rolePermissions[currentUserRole];

    // Show/hide admin-only elements
    adminOnlyElements.forEach((element) => {
        if (isAdmin) {
            element.style.display = "";
        } else {
            element.style.display = "none";
        }
    });

    // Show/hide registration-only elements (opposite of admin)
    registrationOnlyElements.forEach((element) => {
        if (isAdmin) {
            element.style.display = "none";
        } else {
            element.style.display = "";
        }
    });

    // Update sidebar menu based on role
    updateSidebarMenu(permissions.mainMenu);

    // Update mobile navigation
    updateMobileNavigation(permissions.mainMenu);
    
    // Update action icons based on role
    updateActionIcons();

    // If admin and registration page is active, navigate to appointments
    if (isAdmin && document.getElementById("registration-page").classList.contains("active")) {
        navigateToPage("appointments");
    }
}

// Function to update action icons based on role
function updateActionIcons() {
    const isAdmin = currentUserRole === "admin";
    const echoIcons = document.querySelectorAll('.btn-echo');
    const consultIcons = document.querySelectorAll('.btn-consult');
    
    if (isAdmin) {
        echoIcons.forEach(icon => icon.style.display = 'inline-flex');
        consultIcons.forEach(icon => icon.style.display = 'inline-flex');
    } else {
        echoIcons.forEach(icon => icon.style.display = 'none');
        consultIcons.forEach(icon => icon.style.display = 'none');
    }
}

// Function to update sidebar menu based on permissions
function updateSidebarMenu(allowedPages) {
    const menuItems = document.querySelectorAll(".sidebar-menu a");

    menuItems.forEach((item) => {
        const page = item.getAttribute("data-page");
        if (allowedPages.includes(page)) {
            item.style.display = "flex";
        } else {
            item.style.display = "none";
        }
    });
}

// Function to update mobile navigation based on permissions
function updateMobileNavigation(allowedPages) {
    const bottomNavItems = document.querySelectorAll(".bottom-nav-item");

    bottomNavItems.forEach((item) => {
        const page = item.getAttribute("data-page");
        if (allowedPages.includes(page)) {
            item.style.display = "flex";
        } else {
            item.style.display = "none";
        }
    });
}

// Function to navigate to specific page with role check
function navigateToPage(pageId) {
    const permissions = rolePermissions[currentUserRole];

    // Check if user has access to this page
    if (!permissions.accessiblePages.includes(pageId)) {
        showNotification(
            "Access denied. You do not have permission to access this page.",
            "error"
        );
        return;
    }

    document
        .querySelectorAll(".page")
        .forEach((page) => page.classList.remove("active"));
    document
        .querySelectorAll(".sidebar-menu a, .bottom-nav-item")
        .forEach((tab) => tab.classList.remove("active"));

    document.getElementById(`${pageId}-page`).classList.add("active");

    // Update active menu items only if they are visible
    const sidebarItem = document.querySelector(
        `.sidebar-menu a[data-page="${pageId}"]`
    );
    const bottomNavItem = document.querySelector(
        `.bottom-nav-item[data-page="${pageId}"]`
    );

    if (sidebarItem && sidebarItem.style.display !== "none") {
        sidebarItem.classList.add("active");
    }

    if (bottomNavItem && bottomNavItem.style.display !== "none") {
        bottomNavItem.classList.add("active");
    }

    if (pageId === "appointments") {
        updateAppointmentsTable();
    } else if (pageId === "database") {
        updateDatabaseTable();
    }

    if (window.innerWidth <= 992) {
        closeSidebar();
    }
}

// Admin password verification
function verifyAdminPassword() {
    const password = document.getElementById("admin-password").value;
    if (password === "1") {
        currentUserRole = "admin";
        document.getElementById("user-name").innerHTML =
            'Admin User <span class="role-badge role-admin">Admin</span>';
        document.getElementById("user-profile").querySelector("img").src =
            "https://ui-avatars.com/api/?name=Admin+User&background=2563eb&color=fff";

        // Update UI for admin role
        updateUIForUserRole();

        // Close modal
        closeAdminModal();

        showNotification("Admin access granted!", "success");
    } else {
        showNotification("Incorrect password. Please try again.", "error");
        document.getElementById("admin-password").value = "";
        document.getElementById("admin-password").focus();
    }
}

// Open admin modal
function openAdminModal() {
    document.getElementById("admin-modal").classList.add("active");
    document.getElementById("admin-password").focus();
}

// Close admin modal
function closeAdminModal() {
    document.getElementById("admin-modal").classList.remove("active");
    document.getElementById("admin-password").value = "";
}

// Validation functions
function validateField(fieldId, errorId, validationFn) {
    const field = document.getElementById(fieldId);
    const error = document.getElementById(errorId);
    const isValid = validationFn(field.value);

    if (!isValid) {
        error.classList.add("show");
        field.classList.add("error");
        return false;
    } else {
        error.classList.remove("show");
        field.classList.remove("error");
        return true;
    }
}

function validateRequired(value) {
    return value && value.trim() !== "";
}

function validateEmail(email) {
    if (!email) return true; // Email is optional
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

function validateMobile(mobile) {
    const re = /^\d{10}$/;
    return re.test(mobile);
}

function validateNumber(value) {
    if (!value) return true; // Number fields are optional
    return !isNaN(value) && parseFloat(value) >= 0;
}

function validateDate(value) {
    if (!value) return false;
    const date = new Date(value);
    return date instanceof Date && !isNaN(date);
}

// Form validation
function validateForm() {
    let isValid = true;

    // Validate required fields
    isValid = validateField("firstName", "firstName-error", validateRequired) && isValid;
    isValid = validateField("lastName", "lastName-error", validateRequired) && isValid;
    isValid = validateField("sex", "sex-error", validateRequired) && isValid;
    isValid = validateField("dob", "dob-error", validateDate) && isValid;
    isValid = validateField("mobile", "mobile-error", validateMobile) && isValid;
    isValid = validateField("address", "address-error", validateRequired) && isValid;
    isValid = validateField("appointmentDate", "appointmentDate-error", validateDate) && isValid;
    isValid = validateField("appointmentTime", "appointmentTime-error", validateRequired) && isValid;

    // Validate optional fields
    isValid = validateField("email", "email-error", validateEmail) && isValid;
    isValid = validateField("weight", "weight-error", validateNumber) && isValid;
    isValid = validateField("height", "height-error", validateNumber) && isValid;

    return isValid;
}

// Clear form function
function clearForm() {
    if (confirm("Are you sure you want to clear all form data?")) {
        document.getElementById("patientForm").reset();
        generateNewPatientId();

        // Set default appointment date to today
        const today = new Date();
        const formattedDate = today.toISOString().split("T")[0];
        document.getElementById("appointmentDate").value = formattedDate;

        // Clear all error messages
        document.querySelectorAll(".error-message").forEach(error => {
            error.classList.remove("show");
        });
        document.querySelectorAll(".error").forEach(field => {
            field.classList.remove("error");
        });
    }
}

// Generate new unique patient ID
function generateNewPatientId() {
    // Generate a random 7-digit number that's unlikely to conflict
    const newId = Math.floor(1000000 + Math.random() * 9000000).toString();
    document.getElementById("patientId").value = newId;
    return newId;
}

// Function to delete an appointment
function deleteAppointment(patientId) {
    if (
        confirm(
            "Are you sure you want to delete this appointment? This action cannot be undone."
        )
    ) {
        // Find the patient index
        const patientIndex = patients.findIndex(
            (patient) => patient.id === patientId
        );

        if (patientIndex !== -1) {
            // Remove the patient from the array
            patients.splice(patientIndex, 1);

            // Save to localStorage
            savePatientsToStorage();

            // Update the appointments table
            updateAppointmentsTable();

            showNotification("Appointment deleted successfully!", "success");
        } else {
            showNotification("Patient not found!", "error");
        }
    }
}

// Helper functions
function calculateAge(dob) {
    if (!dob) return 'N/A';
    
    try {
        const birthDate = new Date(dob);
        if (isNaN(birthDate.getTime())) return 'N/A';
        
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();

        if (
            monthDiff < 0 ||
            (monthDiff === 0 && today.getDate() < birthDate.getDate())
        ) {
            age--;
        }

        return age;
    } catch (error) {
        console.error('Error calculating age:', error);
        return 'N/A';
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';
        
        return date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
        });
    } catch (error) {
        console.error('Error formatting date:', error);
        return 'N/A';
    }
}

function formatTime(timeString) {
    if (!timeString) return 'N/A';
    
    try {
        // Handle null, undefined, or empty strings
        if (typeof timeString !== 'string') return 'N/A';
        
        // Handle "HH:MM:SS" format by removing seconds
        let timeParts = timeString.split(':');
        if (timeParts.length < 2) return 'N/A';
        
        // Take only hours and minutes
        const hours = parseInt(timeParts[0]);
        const minutes = timeParts[1];
        
        if (isNaN(hours) || isNaN(parseInt(minutes))) return 'N/A';
        
        const ampm = hours >= 12 ? "PM" : "AM";
        const displayHour = hours % 12 || 12;
        return `${displayHour}:${minutes} ${ampm}`;
    } catch (error) {
        console.error('Error formatting time:', error, timeString);
        return 'N/A';
    }
}

// Helper function to find patient by ID, name, or mobile
function findPatient(searchTerm) {
    if (!searchTerm) return null;
    
    const searchLower = searchTerm.toString().toLowerCase();
    
    return patients.find(patient => 
        (patient.id && patient.id.toString().toLowerCase().includes(searchLower)) ||
        (patient.firstName && patient.firstName.toLowerCase().includes(searchLower)) ||
        (patient.lastName && patient.lastName.toLowerCase().includes(searchLower)) ||
        (patient.firstName && patient.lastName && 
         `${patient.firstName} ${patient.lastName}`.toLowerCase().includes(searchLower)) ||
        (patient.mobile && patient.mobile.toString().includes(searchTerm))
    );
}

// Helper function to find patient by ID only
function findPatientById(patientId) {
    return patients.find(patient => patient.id === patientId);
}

// Update appointments table
function updateAppointmentsTable() {
    const tableBody = document.getElementById("appointmentsTableBody");
    const searchTerm = document
        .getElementById("searchPatient")
        .value.toLowerCase();
    const statusFilter = document.getElementById("filterStatus").value;

    tableBody.innerHTML = "";

    const filteredPatients = patients.filter((patient) => {
        const matchesSearch =
            (patient.id && patient.id.toLowerCase().includes(searchTerm)) ||
            (patient.firstName && patient.lastName && 
             `${patient.firstName} ${patient.lastName}`
                .toLowerCase()
                .includes(searchTerm)) ||
            (patient.mobile && patient.mobile.includes(searchTerm));

        let matchesStatus = true;
        if (statusFilter === "follow-up") {
            matchesStatus = patient.followUps && patient.followUps.length > 0;
        } else if (statusFilter !== "all") {
            matchesStatus = patient.status === statusFilter;
        }

        return matchesSearch && matchesStatus;
    });

    filteredPatients.forEach((patient) => {
        const age = calculateAge(patient.dob);
        const nextFollowUp =
            patient.followUps && patient.followUps.length > 0
                ? patient.followUps[patient.followUps.length - 1]
                : null;

        const row = document.createElement("tr");

        row.innerHTML = `
            <td>${patient.id || 'N/A'}</td>
            <td>${patient.firstName || ''} ${patient.lastName || ''}</td>
            <td>${
                patient.sex ? patient.sex.charAt(0).toUpperCase() + patient.sex.slice(1) : 'N/A'
            }</td>
            <td>${age} years</td>
            <td>${patient.mobile || 'N/A'}</td>
            <td>${formatDate(patient.appointmentDate)}</td>
            <td>${formatTime(patient.appointmentTime)}</td>
            <td><span class="status-badge status-${patient.status || 'scheduled'}">${
            (patient.status || 'scheduled').charAt(0).toUpperCase() + (patient.status || 'scheduled').slice(1)
        }</span></td>
            <td>${
                nextFollowUp ? formatDate(nextFollowUp.date) : "None"
            }</td>
            <td>
                <div class="action-icons">
                    <button class="action-icon see-icon" onclick="viewPatient('${
                        patient.id
                    }')" title="View Patient">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-icon follow-up-icon" onclick="showFollowUpForm('${
                        patient.id
                    }')" title="Schedule Follow-up">
                        <i class="fas fa-calendar-plus"></i>
                    </button>
                    <button class="action-icon btn-echo" onclick="goToEchoReport('${
                        patient.id
                    }')" title="Go to Echo Report">
                        <i class="fas fa-heartbeat"></i>
                    </button>
                    <button class="action-icon btn-consult" onclick="goToConsultReport('${
                        patient.id
                    }')" title="Go to Consultant Report">
                        <i class="fas fa-user-md"></i>
                    </button>
                    <button class="action-icon btn-delete" onclick="deleteAppointment('${
                        patient.id
                    }')" title="Delete Appointment">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;

        tableBody.appendChild(row);
    });

    if (filteredPatients.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="10" style="text-align: center;">No appointments found</td>`;
        tableBody.appendChild(row);
    }
}

// Update database table
function updateDatabaseTable() {
    const tableBody = document.getElementById("databaseTableBody");
    const searchTerm = document
        .getElementById("searchDatabase")
        .value.toLowerCase();
    const filter = document.getElementById("filterDatabase").value;

    tableBody.innerHTML = "";

    const filteredPatients = patients.filter((patient) => {
        const matchesSearch =
            patient.id.toLowerCase().includes(searchTerm) ||
            `${patient.firstName} ${patient.lastName}`
                .toLowerCase()
                .includes(searchTerm) ||
            patient.mobile.includes(searchTerm);

        let matchesFilter = true;
        if (filter === "echo") {
            matchesFilter = patient.echoReports && patient.echoReports.length > 0;
        } else if (filter === "consultation") {
            matchesFilter = patient.consultations && patient.consultations.length > 0;
        } else if (filter === "registration") {
            matchesFilter = true; // All registered patients
        }

        return matchesSearch && matchesFilter;
    });

    filteredPatients.forEach((patient) => {
        const age = calculateAge(patient.dob);
        const echoCount = patient.echoReports ? patient.echoReports.length : 0;
        const consultCount = patient.consultations ? patient.consultations.length : 0;
        
        // Calculate BMI if height and weight are available
        let bmi = "N/A";
        if (patient.height && patient.weight) {
            const heightInMeters = patient.height / 100;
            bmi = (patient.weight / (heightInMeters * heightInMeters)).toFixed(2);
        }
        
        // Get latest echo report data
        let indication = "N/A";
        let diagnosis = "N/A";
        let impression = "N/A";
        let advise = "N/A";
        let nextFollowUp = "N/A";
        
        if (patient.echoReports && patient.echoReports.length > 0) {
            const latestEcho = patient.echoReports[patient.echoReports.length - 1];
            indication = latestEcho.indication || "N/A";
            diagnosis = latestEcho.diagnosis ? latestEcho.diagnosis.substring(0, 50) + "..." : "N/A";
            impression = latestEcho.impression ? latestEcho.impression.substring(0, 50) + "..." : "N/A";
            advise = latestEcho.advise || "N/A";
            nextFollowUp = latestEcho.nextFollowUp || "N/A";
        }

        const row = document.createElement("tr");

        row.innerHTML = `
            <td>${patient.id}</td>
            <td>${patient.firstName} ${patient.lastName}</td>
            <td>${patient.sex.charAt(0).toUpperCase() + patient.sex.slice(1)}</td>
            <td>${age} years</td>
            <td>${patient.mobile}</td>
            <td>${patient.height || "N/A"} cm</td>
            <td>${patient.weight || "N/A"} kg</td>
            <td>${bmi}</td>
            <td>${indication}</td>
            <td>${diagnosis}</td>
            <td>${impression}</td>
            <td>${advise}</td>
            <td>${nextFollowUp}</td>
            <td>
                <div class="action-icons">
                    <button class="action-icon see-icon" onclick="viewPatientDetails('${
                        patient.id
                    }')" title="View Patient Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-icon btn-echo" onclick="goToEchoReport('${
                        patient.id
                    }')" title="Go to Echo Report">
                        <i class="fas fa-heartbeat"></i>
                    </button>
                    <button class="action-icon btn-consult" onclick="goToConsultReport('${
                        patient.id
                    }')" title="Go to Consultant Report">
                        <i class="fas fa-user-md"></i>
                    </button>
                </div>
            </td>
        `;

        tableBody.appendChild(row);
    });

    if (filteredPatients.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="14" style="text-align: center;">No patients found</td>`;
        tableBody.appendChild(row);
    }
}

// Navigation functions
function goToEchoReport(patientId) {
    const permissions = rolePermissions[currentUserRole];

    // Check if user has access to Echo Reports
    if (!permissions.accessiblePages.includes("echo")) {
        showNotification(
            "Access denied. You do not have permission to access Echo Reports.",
            "error"
        );
        return;
    }

    const patient = findPatient(patientId);
    if (patient) {
        navigateToPage("echo");

        document.getElementById("searchEchoPatient").value = patient.id;

        searchEchoPatient();

        window.scrollTo(0, 0);
    }
}

function goToConsultReport(patientId) {
    const permissions = rolePermissions[currentUserRole];

    // Check if user has access to Consultation
    if (!permissions.accessiblePages.includes("consultation")) {
        showNotification(
            "Access denied. You do not have permission to access Consultation.",
            "error"
        );
        return;
    }

    const patient = findPatient(patientId);
    if (patient) {
        navigateToPage("consultation");

        document.getElementById("searchConsultPatient").value = patient.id;

        searchConsultPatient();

        window.scrollTo(0, 0);
    }
}

function viewPatient(patientId) {
    const patient = findPatient(patientId);
    if (patient) {
        navigateToPage("registration");

        document.getElementById("patientId").value = patient.id;
        document.getElementById("firstName").value = patient.firstName;
        document.getElementById("lastName").value = patient.lastName;
        document.getElementById("sex").value = patient.sex;
        document.getElementById("dob").value = patient.dob;
        document.getElementById("email").value = patient.email;
        document.getElementById("mobile").value = patient.mobile;
        document.getElementById("address").value = patient.address;
        document.getElementById("weight").value = patient.weight;
        document.getElementById("height").value = patient.height;
        document.getElementById("bloodPressure").value =
            patient.bloodPressure;
        document.getElementById("heartRate").value = patient.heartRate;
        document.getElementById("spo2").value = patient.spo2;
        document.getElementById("appointmentDate").value =
            patient.appointmentDate;
        document.getElementById("appointmentTime").value =
            patient.appointmentTime;

        window.scrollTo(0, 0);
    }
}

function viewPatientDetails(patientId) {
    const patient = findPatient(patientId);
    if (patient) {
        // Safely get consultations count
        const consultationsCount = patient.consultations ? patient.consultations.length : 0;
        const echoReportsCount = patient.echoReports ? patient.echoReports.length : 0;
        
        alert(
            `Patient Details:\n\nID: ${patient.id}\nName: ${
                patient.firstName
            } ${patient.lastName}\nSex: ${patient.sex}\nAge: ${calculateAge(
                patient.dob
            )} years\nMobile: ${patient.mobile}\nEcho Reports: ${
                echoReportsCount
            }\nConsultations: ${consultationsCount}`
        );
    }
}

// Search functions
async function searchEchoPatient() {
    const searchTerm = document.getElementById("searchEchoPatient").value.trim();
    
    if (!searchTerm) {
        showNotification("Please enter a patient ID or name to search.", "error");
        return;
    }

    try {
        showNotification("Searching for patient...", "info");

        // Find patient in local array
        let patient = findPatient(searchTerm);
        
        if (!patient) {
            showNotification("Patient not found in local data. Please check the ID.", "error");
            return;
        }

        // Update patient details in echo report
        updateEchoPatientDetails(patient);
        
        // Load echo reports from database
        await loadEchoReportsForPatient(patient.id);
        
        showNotification(`Patient found: ${patient.firstName} ${patient.lastName}`, "success");

    } catch (error) {
        console.error('Error searching patient:', error);
        showNotification("Error searching for patient: " + error.message, "error");
    }
}

// Update echo report with patient details
function updateEchoPatientDetails(patient) {
    console.log(' Updating patient details:', patient);
    
    document.getElementById("reg-no").textContent = patient.id || 'N/A';
    document.getElementById("patient-name").textContent = `${patient.firstName || ''} ${patient.lastName || ''}`;
    document.getElementById("gender").textContent = patient.sex ? patient.sex.charAt(0).toUpperCase() + patient.sex.slice(1) : 'N/A';
    document.getElementById("age").textContent = `${calculateAge(patient.dob)} years`;
    document.getElementById("dob").textContent = formatDate(patient.dob);
    document.getElementById("address").textContent = patient.address || 'N/A';
    document.getElementById("weight").textContent = patient.weight ? `${patient.weight} kg` : 'N/A';
    document.getElementById("height").textContent = patient.height ? `${patient.height} cm` : 'N/A';
    
    // Calculate BMI
    if (patient.height && patient.weight) {
        const heightInMeters = patient.height / 100;
        const bmi = (patient.weight / (heightInMeters * heightInMeters)).toFixed(2);
        document.getElementById("bmi").textContent = bmi;
    } else {
        document.getElementById("bmi").textContent = 'N/A';
    }
    
    document.getElementById("hr").textContent = patient.heartRate ? `${patient.heartRate} bpm` : 'N/A';
    document.getElementById("bp").textContent = patient.bloodPressure || 'N/A';
    document.getElementById("spo2").textContent = patient.spo2 ? `${patient.spo2}%` : 'N/A';

    // Set current date
    const today = new Date();
    const formattedDate = formatDate(today.toISOString().split('T')[0]);
    document.getElementById("report-date").textContent = `Date: ${formattedDate}`;
}

// Load echo reports for patient from database
async function loadEchoReportsForPatient(patientId) {
    try {
        console.log(' Loading echo reports for patient:', patientId);
        
        const echoReports = await apiCall(`/api/echo-reports/${patientId}`);
        console.log(' Echo reports from database:', echoReports);
        
        if (echoReports && echoReports.length > 0) {
            // Get the latest echo report
            const latestReport = echoReports[echoReports.length - 1];
            console.log(' Latest echo report:', latestReport);
            
            // Populate the echo report fields with proper formatting
            document.getElementById("echo-diagnosis").innerHTML = latestReport.diagnosis || '';
            document.getElementById("echo-impression").innerHTML = latestReport.impression || '';
            
            // Update indication and reference doctor if available
            if (latestReport.indication) {
                document.getElementById("indication").textContent = latestReport.indication;
            }
            if (latestReport.ref_dr) {
                document.getElementById("ref-dr").textContent = latestReport.ref_dr;
            }
            
            showNotification(` Loaded existing echo report from ${latestReport.report_date}`, "success");
        } else {
            // Clear fields if no reports exist
            document.getElementById("echo-diagnosis").innerHTML = '';
            document.getElementById("echo-impression").innerHTML = '';
            document.getElementById("indication").textContent = 'Routine Checkup';
            document.getElementById("ref-dr").textContent = 'Dr. Shubham Bafna';
            console.log(' No existing echo reports found for this patient');
        }
    } catch (error) {
        console.error(' Error loading echo reports:', error);
        // If error, clear the fields
        document.getElementById("echo-diagnosis").innerHTML = '';
        document.getElementById("echo-impression").innerHTML = '';
        showNotification(" Could not load previous reports", "info");
    }
}

async function searchConsultPatient() {
    const searchTerm = document.getElementById("searchConsultPatient").value.trim();
    
    if (!searchTerm) {
        showNotification("Please enter a patient ID or name to search.", "error");
        return;
    }

    try {
        showNotification("Searching for patient...", "info");

        // Find patient in local array
        let patient = findPatient(searchTerm);
        
        if (!patient) {
            showNotification("Patient not found in local data. Please check the ID.", "error");
            return;
        }

        // Update patient details in consultation report
        updateConsultPatientDetails(patient);
        
        // Load consultation reports from database
        await loadConsultReportsForPatient(patient.id);
        
        showNotification(`Patient found: ${patient.firstName} ${patient.lastName}`, "success");

    } catch (error) {
        console.error('Error searching patient:', error);
        showNotification("Error searching for patient: " + error.message, "error");
    }
}

// Load consultation reports for patient from database
async function loadConsultReportsForPatient(patientId) {
    try {
        console.log(' Loading consultation reports for patient:', patientId);
        
        const consultReports = await apiCall(`/api/consultation-reports/${patientId}`);
        console.log(' Consultation reports from database:', consultReports);
        
        if (consultReports && consultReports.length > 0) {
            // Get the latest consultation report
            const latestReport = consultReports[consultReports.length - 1];
            console.log(' Latest consultation report:', latestReport);
            
            // Populate the consultation content
            document.getElementById("consult-content").innerHTML = latestReport.content || '';
            
            // Update indication if available
            if (latestReport.indication) {
                document.getElementById("consult-indication").textContent = latestReport.indication;
            }
            
            showNotification(` Loaded existing consultation report from ${latestReport.report_date}`, "success");
        } else {
            // Clear content if no reports exist
            document.getElementById("consult-content").innerHTML = '';
            document.getElementById("consult-indication").textContent = 'Routine Checkup';
            console.log(' No existing consultation reports found for this patient');
        }
    } catch (error) {
        console.error(' Error loading consultation reports:', error);
        // If error, clear the content
        document.getElementById("consult-content").innerHTML = '';
        showNotification(" Could not load previous consultation reports", "info");
    }
}

// Update consultation report with patient details
function updateConsultPatientDetails(patient) {
    console.log(' Updating consultation patient details:', patient);
    
    document.getElementById("consult-reg-no").textContent = patient.id || 'N/A';
    document.getElementById("consult-patient-name").textContent = `${patient.firstName || ''} ${patient.lastName || ''}`;
    document.getElementById("consult-gender").textContent = patient.sex ? patient.sex.charAt(0).toUpperCase() + patient.sex.slice(1) : 'N/A';
    document.getElementById("consult-age").textContent = `${calculateAge(patient.dob)} years`;
    document.getElementById("consult-dob").textContent = formatDate(patient.dob);
    document.getElementById("consult-address").textContent = patient.address || 'N/A';
    document.getElementById("consult-weight").textContent = patient.weight ? `${patient.weight} kg` : 'N/A';
    document.getElementById("consult-height").textContent = patient.height ? `${patient.height} cm` : 'N/A';
    
    // Calculate BMI
    if (patient.height && patient.weight) {
        const heightInMeters = patient.height / 100;
        const bmi = (patient.weight / (heightInMeters * heightInMeters)).toFixed(2);
        document.getElementById("consult-bmi").textContent = bmi;
    } else {
        document.getElementById("consult-bmi").textContent = 'N/A';
    }
    
    document.getElementById("consult-hr").textContent = patient.heartRate ? `${patient.heartRate} bpm` : 'N/A';
    document.getElementById("consult-bp").textContent = patient.bloodPressure || 'N/A';
    document.getElementById("consult-spo2").textContent = patient.spo2 ? `${patient.spo2}%` : 'N/A';

    // Set current date
    const today = new Date();
    const formattedDate = formatDate(today.toISOString().split('T')[0]);
    document.getElementById("consult-report-date-value").textContent = formattedDate;
}

// Follow-up functions
let currentFollowUpPatient = null;

function showFollowUpForm(patientId) {
    const patient = findPatient(patientId);
    if (patient) {
        currentFollowUpPatient = patient;
        document.getElementById("follow-up-patient-id").value = patient.id;
        document.getElementById(
            "follow-up-patient-name"
        ).value = `${patient.firstName} ${patient.lastName}`;

        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        document.getElementById("follow-up-date").value = nextWeek
            .toISOString()
            .split("T")[0];

        document.getElementById("follow-up-form").classList.add("active");

        document.querySelector(".follow-up-section").scrollIntoView({
            behavior: "smooth",
            block: "start",
        });
    }
}

function saveFollowUp() {
    if (!currentFollowUpPatient) return;

    const followUpDate = document.getElementById("follow-up-date").value;
    const followUpTime = document.getElementById("follow-up-time").value;
    const followUpReason =
        document.getElementById("follow-up-reason").value;

    if (!followUpDate || !followUpTime) {
        showNotification(
            "Please select both date and time for follow-up.",
            "error"
        );
        return;
    }

    const followUp = {
        date: followUpDate,
        time: followUpTime,
        reason: followUpReason,
        status: "scheduled",
    };

    if (!currentFollowUpPatient.followUps) {
        currentFollowUpPatient.followUps = [];
    }

    currentFollowUpPatient.followUps.push(followUp);

    savePatientsToStorage();
    updateAppointmentsTable();
    updateFollowUpTable();

    cancelFollowUp();

    showNotification("Follow-up scheduled successfully!", "success");
}

function cancelFollowUp() {
    document.getElementById("follow-up-form").classList.remove("active");
    document.getElementById("follow-up-date").value = "";
    document.getElementById("follow-up-time").value = "";
    document.getElementById("follow-up-reason").value = "";
    currentFollowUpPatient = null;
}

function updateFollowUpTable() {
    const tableBody = document.getElementById("follow-up-table-body");
    tableBody.innerHTML = "";

    const today = new Date().toISOString().split("T")[0];
    let allFollowUps = [];

    patients.forEach((patient) => {
        if (patient.followUps && Array.isArray(patient.followUps)) {
            patient.followUps.forEach((followUp) => {
                if (followUp.date >= today && followUp.status === "scheduled") {
                    allFollowUps.push({
                        patientId: patient.id,
                        patientName: `${patient.firstName} ${patient.lastName}`,
                        ...followUp,
                    });
                }
            });
        }
    });

    allFollowUps.sort((a, b) => new Date(a.date) - new Date(b.date));

    allFollowUps.forEach((followUp) => {
        const row = document.createElement("tr");

        row.innerHTML = `
            <td>${followUp.patientId}</td>
            <td>${followUp.patientName}</td>
            <td>${formatDate(followUp.date)}</td>
            <td>${formatTime(followUp.time)}</td>
            <td>${followUp.reason}</td>
            <td>
                <div class="action-icons">
                    <button class="action-icon see-icon" onclick="viewPatient('${
                        followUp.patientId
                    }')" title="View Patient">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </td>
        `;

        tableBody.appendChild(row);
    });

    if (allFollowUps.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="6" style="text-align: center;">No upcoming follow-ups</td>`;
        tableBody.appendChild(row);
    }
}

// Mobile sidebar functions
function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebar-overlay");

    sidebar.classList.toggle("active");
    overlay.classList.toggle("active");
}

function closeSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebar-overlay");

    sidebar.classList.remove("active");
    overlay.classList.remove("active");
}

// Notification function
function showNotification(message, type = "info") {
    // Create notification element
    const notification = document.createElement("div");
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${
                type === "success"
                    ? "check-circle"
                    : type === "error"
                    ? "exclamation-circle"
                    : "info-circle"
            }"></i>
            <span>${message}</span>
        </div>
    `;

    // Style the notification
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${
            type === "success"
                ? "#10b981"
                : type === "error"
                ? "#ef4444"
                : type === "warning"
                ? "#f59e0b"
                : "#3b82f6"
        };
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 300px;
    `;

    document.body.appendChild(notification);

    // Remove notification after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// Function to make API calls
async function apiCall(endpoint, options = {}) {
    try {
        const response = await fetch(`http://localhost:4000${endpoint}`, {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            const errorMessage = errorData.error || errorData.message || `HTTP error! status: ${response.status}`;
            
            // Handle specific error cases
            if (errorMessage.includes('already exists') || errorMessage.includes('Duplicate')) {
                throw new Error('Patient ID already exists. Please use a different ID.');
            }
            
            throw new Error(errorMessage);
        }
        
        return await response.json();
    } catch (error) {
        console.error('API call failed:', error);
        const errorMessage = error.message || 'Database connection failed. Please check your connection.';
        showNotification(errorMessage, 'error');
        throw error;
    }
}

async function loadAllDataFromDatabase() {
    try {
        console.log(' Loading data from MySQL database...');
        
        // Load patients
        const patientsData = await apiCall('/api/all-patients');
        patients.length = 0; // Clear existing array
        patients.push(...patientsData.map(p => ({
            id: p.patient_id || '',
            firstName: p.first_name || '',
            lastName: p.last_name || '',
            sex: (p.sex || '').toLowerCase(),
            dob: p.date_of_birth || '',
            email: p.email || '',
            mobile: p.mobile_no || '',
            address: p.address || '',
            weight: p.weight || '',
            height: p.height || '',
            bloodPressure: p.blood_pressure || '',
            heartRate: p.heart_rate || '',
            spo2: p.spo2 || '',
            status: "scheduled",
            appointmentDate: p.appointment_date || '',
            appointmentTime: p.appointment_time || '',
            echoReports: [],
            consultations: [],
            followUps: []
        })));

        // Load echo reports
        const echoReportsData = await apiCall('/api/all-echo-reports');
        echoReportsData.forEach(echo => {
            const patient = patients.find(p => p.id === echo.patient_id);
            if (patient) {
                if (!patient.echoReports) patient.echoReports = [];
                patient.echoReports.push({
                    date: echo.report_date || '',
                    diagnosis: echo.diagnosis || '',
                    impression: echo.impression || '',
                    indication: echo.indication || '',
                    ref: echo.ref_dr || '',
                    advise: echo.advise || '',
                    nextFollowUp: echo.next_follow_up || ''
                });
            }
        });

        // Load consultation reports
        const consultReportsData = await apiCall('/api/all-consultation-reports');
        consultReportsData.forEach(consult => {
            const patient = patients.find(p => p.id === consult.patient_id);
            if (patient) {
                if (!patient.consultations) patient.consultations = [];
                patient.consultations.push({
                    date: consult.report_date || '',
                    content: consult.content || '',
                    indication: consult.indication || '',
                    advice: consult.advise || '',
                    nextFollowUp: consult.next_follow_up || ''
                });
            }
        });

        // Load follow-ups
        const followUpsData = await apiCall('/api/all-follow-ups');
        followUpsData.forEach(follow => {
            const patient = patients.find(p => p.id === follow.patient_id);
            if (patient) {
                if (!patient.followUps) patient.followUps = [];
                patient.followUps.push({
                    date: follow.follow_up_date || '',
                    time: follow.follow_up_time || '',
                    reason: follow.reason || '',
                    status: follow.status || 'scheduled'
                });
            }
        });

        console.log(' Data loaded successfully from MySQL!');
        console.log(`   Patients: ${patients.length}`);
        console.log(`   Echo Reports: ${echoReportsData.length}`);
        console.log(`   Consultation Reports: ${consultReportsData.length}`);
        console.log(`   Follow-ups: ${followUpsData.length}`);

        // Update UI
        updateAppointmentsTable();
        updateDatabaseTable();
        updateFollowUpTable();

    } catch (error) {
        console.error(' Error loading data from database:', error);
        showNotification('Error loading data from database. Using local storage.', 'warning');
        
        // Fallback to localStorage
        const storedPatients = localStorage.getItem("vamaPatients");
        if (storedPatients) {
            patients = JSON.parse(storedPatients);
            updateAppointmentsTable();
            updateDatabaseTable();
            updateFollowUpTable();
        }
    }
}

// Function to register patient form handler
function registerPatientFormHandler() {
    const patientForm = document.getElementById("patientForm");
    if (!patientForm) {
        console.error(' Patient form not found!');
        return;
    }

    // Remove old event listeners by replacing the form
    const newForm = patientForm.cloneNode(true);
    patientForm.parentNode.replaceChild(newForm, patientForm);
    
    // Get the new form element
    const form = document.getElementById("patientForm");
    
    // Add the API handler
    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        e.stopPropagation();

        console.log(' Form submitted!');

        if (!validateForm()) {
            showNotification("Please fix the validation errors before submitting.", "error");
            return;
        }

        const newPatient = {
            id: document.getElementById("patientId").value,
            firstName: document.getElementById("firstName").value,
            lastName: document.getElementById("lastName").value,
            sex: document.getElementById("sex").value,
            dob: document.getElementById("dob").value,
            email: document.getElementById("email").value,
            mobile: document.getElementById("mobile").value,
            address: document.getElementById("address").value,
            weight: document.getElementById("weight").value,
            height: document.getElementById("height").value,
            bloodPressure: document.getElementById("bloodPressure").value,
            heartRate: document.getElementById("heartRate").value,
            spo2: document.getElementById("spo2").value,
            appointmentDate: document.getElementById("appointmentDate").value,
            appointmentTime: document.getElementById("appointmentTime").value
        };

        console.log(' Patient data to submit:', newPatient);

        try {
            console.log(' Submitting patient data to server...');
            const response = await apiCall('/api/patients', {
                method: 'POST',
                body: JSON.stringify(newPatient)
            });

            console.log(' Server response:', response);

            // Also add to local array for immediate UI update
            patients.push({ ...newPatient, status: "scheduled", echoReports: [], consultations: [], followUps: [] });

            showNotification(" Patient registration submitted successfully! Data saved to MySQL Workbench.", "success");
            clearForm();
            generateNewPatientId();
            navigateToPage("appointments");
        } catch (error) {
            console.error(' Form submission error:', error);
            
            // If it's a duplicate error, generate a new ID and suggest retry
            if (error.message.includes('already exists') || error.message.includes('Duplicate')) {
                const newId = generateNewPatientId();
                showNotification(`Patient ID already exists. New ID ${newId} generated. Please submit again.`, "error");
            }
        }
    });
    
    console.log(' Patient form submission handler registered successfully!');
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the application
    generateNewPatientId();
    updateUIForUserRole();
    updateCustomButtonsList();
    updateEchoCustomButtonsList();

    // Set default appointment date to today
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    document.getElementById('appointmentDate').value = formattedDate;

    // Register the patient form handler
    registerPatientFormHandler();

    // Load data from MySQL database
    loadAllDataFromDatabase();

    // Mobile menu toggle
    document.getElementById('mobile-menu-toggle').addEventListener('click', toggleSidebar);
    document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);

    // User dropdown
    document.getElementById('user-profile').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('user-dropdown').classList.toggle('active');
    });

    // User role switching
    document.querySelectorAll('.user-dropdown-item').forEach(item => {
        item.addEventListener('click', function() {
            const role = this.getAttribute('data-role');
            
            if (role === 'admin') {
                openAdminModal();
            } else {
                currentUserRole = 'receptionist';
                document.getElementById('user-name').innerHTML = 'Receptionist <span class="role-badge role-receptionist">Receptionist</span>';
                document.getElementById('user-profile').querySelector('img').src = 'https://ui-avatars.com/api/?name=Receptionist&background=10b981&color=fff';
                
                // Update UI for receptionist role
                updateUIForUserRole();
                
                // Navigate to accessible page
                navigateToPage('registration');
            }
            
            document.getElementById('user-dropdown').classList.remove('active');
            document.querySelectorAll('.user-dropdown-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
        document.getElementById('user-dropdown').classList.remove("active");
    });

    // Navigation event listeners
    document.querySelectorAll('.sidebar-menu a, .bottom-nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const pageId = this.getAttribute('data-page');
            navigateToPage(pageId);
        });
    });

    // Search functionality
    document.getElementById('searchPatient').addEventListener('input', updateAppointmentsTable);
    document.getElementById('filterStatus').addEventListener('change', updateAppointmentsTable);
    document.getElementById('searchDatabase').addEventListener('input', updateDatabaseTable);
    document.getElementById('filterDatabase').addEventListener('change', updateDatabaseTable);

    // Real-time validation
    document.getElementById('mobile').addEventListener('input', function() {
        validateField('mobile', 'mobile-error', validateMobile);
    });

    document.getElementById('email').addEventListener('input', function() {
        validateField('email', 'email-error', validateEmail);
    });

    document.getElementById('weight').addEventListener('input', function() {
        validateField('weight', 'weight-error', validateNumber);
    });

    document.getElementById('height').addEventListener('input', function() {
        validateField('height', 'height-error', validateNumber);
    });

    // Enter key support for search
    document.getElementById('searchEchoPatient').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchEchoPatient();
        }
    });

    document.getElementById('searchConsultPatient').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchConsultPatient();
        }
    });

    // Admin password input enter key support
    document.getElementById('admin-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            verifyAdminPassword();
        }
    });

    // File name input enter key support
    document.getElementById('file-name-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            savePDFWithFileExplorer();
        }
    });

    // Responsive adjustments
    window.addEventListener('resize', function() {
        if (window.innerWidth > 992) {
            closeSidebar();
        }
    });
});

// Export all functions to global scope
window.navigateToPage = navigateToPage;
window.toggleEchoEditMode = toggleEchoEditMode;
window.toggleConsultEditMode = toggleConsultEditMode;
window.saveEchoReport = saveEchoReport;
window.saveConsultReport = saveConsultReport;
window.printEchoReport = printEchoReport;
window.printConsultReport = printConsultReport;
window.saveEchoAsPDF = saveEchoAsPDF;
window.saveConsultAsPDF = saveConsultAsPDF;
window.applyEchoPreset = applyEchoPreset;
window.applyConsultPreset = applyConsultPreset;
window.searchEchoPatient = searchEchoPatient;
window.searchConsultPatient = searchConsultPatient;
window.clearForm = clearForm;
window.deleteAppointment = deleteAppointment;
window.viewPatient = viewPatient;
window.viewPatientDetails = viewPatientDetails;
window.goToEchoReport = goToEchoReport;
window.goToConsultReport = goToConsultReport;
window.showFollowUpForm = showFollowUpForm;
window.saveFollowUp = saveFollowUp;
window.cancelFollowUp = cancelFollowUp;
window.addCustomButton = addCustomButton;
window.deleteCustomButton = deleteCustomButton;
window.addEchoCustomButton = addEchoCustomButton;
window.deleteEchoCustomButton = deleteEchoCustomButton;
window.applyCustomPreset = applyCustomPreset;
window.applyEchoCustomPreset = applyEchoCustomPreset;
window.verifyAdminPassword = verifyAdminPassword;
window.closeAdminModal = closeAdminModal;
window.openAdminModal = openAdminModal;
window.closeFileExplorer = closeFileExplorer;
window.savePDFWithFileExplorer = savePDFWithFileExplorer;
window.navigateUp = navigateUp;
window.findPatient = findPatient;
window.findPatientById = findPatientById;

// Initialize the application
console.log('VAMA Clinic Patient Management System initialized');
    </script>
</body>
</html>